<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0a1128">
    <title>Sovereign Zenith - Shadow Monarch System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        * { 
            font-family: 'Orbitron', sans-serif;
            -webkit-tap-highlight-color: rgba(59, 130, 246, 0.3);
        }
        html {
            -webkit-text-size-adjust: 100%;
            touch-action: manipulation;
        }
        body { 
            background: linear-gradient(135deg, #050820 0%, #0a1128 50%, #0d0d2b 100%);
            /* Gradient animation removed for performance */
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: none;
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            body { padding: 0.5rem !important; }
            .glass { padding: 1rem !important; }
            h1 { font-size: 1.75rem !important; }
            h2 { font-size: 1.25rem !important; }
            button { 
                min-height: 44px;
                font-size: 0.875rem;
            }
            input, select, textarea {
                font-size: 16px !important;
            }
        }
        
        .content-panel {
            -webkit-overflow-scrolling: touch;
        }
        
        button:active {
            transform: scale(0.95);
            opacity: 0.8;
        }
        .glass {
            background: linear-gradient(135deg, rgba(10, 25, 47, 0.85) 0%, rgba(15, 23, 42, 0.9) 100%);
            backdrop-filter: blur(10px);
            border: 2px solid transparent;
            background-clip: padding-box;
            position: relative;
            box-shadow: 0 8px 32px 0 rgba(59, 130, 246, 0.2),
                        0 0 0 1px rgba(96, 165, 250, 0.15);
            /* Heavy animations removed for performance */
        }
        /* Shimmer animation removed for performance */
        .neon-glow {
            text-shadow: 0 0 10px #60a5fa, 0 0 20px #60a5fa, 0 0 40px #60a5fa, 0 0 80px #3b82f6;
            animation: textPulse 2s ease-in-out infinite;
        }
        @keyframes textPulse {
            0%, 100% { text-shadow: 0 0 10px #60a5fa, 0 0 20px #60a5fa, 0 0 40px #60a5fa, 0 0 80px #3b82f6; }
            50% { text-shadow: 0 0 20px #60a5fa, 0 0 40px #60a5fa, 0 0 80px #60a5fa, 0 0 120px #3b82f6; }
        }
        .neon-border {
            box-shadow: 0 0 10px #60a5fa, 0 0 20px #60a5fa, 0 0 40px #3b82f6, inset 0 0 20px rgba(96, 165, 250, 0.2);
            animation: borderPulse 2s ease-in-out infinite;
        }
        @keyframes borderPulse {
            0%, 100% { box-shadow: 0 0 10px #60a5fa, 0 0 20px #60a5fa, 0 0 40px #3b82f6, inset 0 0 20px rgba(96, 165, 250, 0.2); }
            50% { box-shadow: 0 0 20px #60a5fa, 0 0 40px #60a5fa, 0 0 60px #3b82f6, inset 0 0 30px rgba(96, 165, 250, 0.4); }
        }
        @keyframes pulse-blue {
            0%, 100% { box-shadow: 0 0 5px #60a5fa, 0 0 10px #3b82f6; transform: scale(1); }
            50% { box-shadow: 0 0 20px #60a5fa, 0 0 40px #60a5fa, 0 0 60px #3b82f6; transform: scale(1.02); }
        }
        .pulse-anim { animation: pulse-blue 2s infinite; }
        @keyframes heavyShake {
            0%, 100% { transform: translate(0, 0) rotate(0deg) scale(1); }
            10% { transform: translate(-15px, -15px) rotate(-2deg) scale(1.05); }
            20% { transform: translate(15px, 15px) rotate(2deg) scale(1.05); }
            30% { transform: translate(-15px, 15px) rotate(-1deg) scale(1.03); }
            40% { transform: translate(15px, -15px) rotate(1deg) scale(1.03); }
            50% { transform: translate(-10px, -10px) rotate(-2deg) scale(1.02); }
            60% { transform: translate(10px, 10px) rotate(2deg) scale(1.02); }
            70% { transform: translate(-10px, 10px) rotate(-1deg) scale(1.01); }
            80% { transform: translate(10px, -10px) rotate(1deg) scale(1.01); }
            90% { transform: translate(-5px, -5px) rotate(-0.5deg) scale(1.005); }
        }
        .domain-expansion {
            animation: heavyShake 0.8s, domainFlash 0.8s;
            filter: brightness(2) saturate(2) contrast(1.3);
            position: relative;
        }
        @keyframes domainFlash {
            0%, 100% { background: transparent; }
            10%, 30%, 50%, 70%, 90% { background: radial-gradient(circle at center, rgba(96, 165, 250, 0.3) 0%, transparent 70%); }
        }
        .domain-expansion::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, rgba(59, 130, 246, 0.4) 0%, transparent 70%);
            pointer-events: none;
            animation: domainExpand 0.8s;
            z-index: 1000;
        }
        @keyframes domainExpand {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.5); opacity: 1; }
            100% { transform: scale(3); opacity: 0; }
        }
        .stealth-mode { 
            filter: grayscale(100%) contrast(1.3) brightness(0.8); 
            animation: stealthPulse 3s ease-in-out infinite;
        }
        @keyframes stealthPulse {
            0%, 100% { filter: grayscale(100%) contrast(1.3) brightness(0.8); }
            50% { filter: grayscale(100%) contrast(1.5) brightness(0.6); }
        }
        .bloodlust-mode { 
            filter: saturate(3) hue-rotate(330deg) brightness(1.3) contrast(1.4); 
            animation: bloodlustPulse 1.5s ease-in-out infinite;
        }
        @keyframes bloodlustPulse {
            0%, 100% { filter: saturate(3) hue-rotate(330deg) brightness(1.3) contrast(1.4); }
            50% { filter: saturate(4) hue-rotate(335deg) brightness(1.5) contrast(1.6); }
        }
        .glitch-gate {
            animation: heavyGlitch 0.3s infinite, glitchPulse 1s infinite;
            border-color: #ef4444 !important;
            box-shadow: 0 0 30px #ef4444, 0 0 60px #dc2626, inset 0 0 20px rgba(239, 68, 68, 0.3) !important;
        }
        @keyframes heavyGlitch {
            0%, 100% { transform: translate(0) skew(0deg); }
            25% { transform: translate(-5px, 5px) skew(2deg); }
            50% { transform: translate(5px, -5px) skew(-2deg); }
            75% { transform: translate(-3px, -3px) skew(1deg); }
        }
        @keyframes glitchPulse {
            0%, 100% { box-shadow: 0 0 30px #ef4444, 0 0 60px #dc2626, inset 0 0 20px rgba(239, 68, 68, 0.3); }
            50% { box-shadow: 0 0 50px #ef4444, 0 0 80px #dc2626, inset 0 0 40px rgba(239, 68, 68, 0.5); }
        }
        .rank-e { color: #94a3b8; text-shadow: 0 0 5px #94a3b8; }
        .rank-d { color: #22d3ee; text-shadow: 0 0 10px #22d3ee; animation: rankGlow 2s ease-in-out infinite; }
        .rank-c { color: #4ade80; text-shadow: 0 0 10px #4ade80; animation: rankGlow 2s ease-in-out infinite; }
        .rank-b { color: #facc15; text-shadow: 0 0 15px #facc15; animation: rankGlow 1.8s ease-in-out infinite; }
        .rank-a { color: #fb923c; text-shadow: 0 0 20px #fb923c; animation: rankGlow 1.5s ease-in-out infinite; }
        .rank-s { 
            color: #f43f5e; 
            text-shadow: 0 0 10px #f43f5e, 0 0 20px #f43f5e, 0 0 40px #dc2626; 
            animation: sRankPulse 1s ease-in-out infinite;
        }
        @keyframes rankGlow {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.5); }
        }
        @keyframes sRankPulse {
            0%, 100% { text-shadow: 0 0 10px #f43f5e, 0 0 20px #f43f5e, 0 0 40px #dc2626; transform: scale(1); }
            50% { text-shadow: 0 0 20px #f43f5e, 0 0 40px #f43f5e, 0 0 60px #dc2626; transform: scale(1.1); }
        }
        .hp-bar {
            background: linear-gradient(90deg, #ef4444 0%, #dc2626 50%, #b91c1c 100%);
            height: 100%;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.6), inset 0 0 10px rgba(255, 255, 255, 0.3);
            animation: hpPulse 2s ease-in-out infinite;
        }
        @keyframes hpPulse {
            0%, 100% { box-shadow: 0 0 20px rgba(239, 68, 68, 0.6), inset 0 0 10px rgba(255, 255, 255, 0.3); }
            50% { box-shadow: 0 0 30px rgba(239, 68, 68, 0.9), inset 0 0 15px rgba(255, 255, 255, 0.5); }
        }
        .penalty-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: penaltyFade 0.5s;
        }
        @keyframes penaltyFade {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
        button {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(96, 165, 250, 0.5);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        button:hover::before {
            width: 300px;
            height: 300px;
        }
        button:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.5);
        }
        button:active {
            transform: translateY(-1px) scale(0.98);
        }
        .arise-animation {
            animation: ariseEffect 1.5s;
        }
        @keyframes ariseEffect {
            0% { transform: translateY(50px) scale(0.8); opacity: 0; }
            30% { transform: translateY(-20px) scale(1.1); opacity: 1; }
            50% { transform: translateY(10px) scale(0.95); }
            70% { transform: translateY(-5px) scale(1.02); }
            100% { transform: translateY(0) scale(1); opacity: 1; }
        }
        .levelup-burst {
            animation: levelBurst 1s;
        }
        @keyframes levelBurst {
            0% { transform: scale(1); filter: brightness(1); }
            20% { transform: scale(1.3); filter: brightness(2); }
            40% { transform: scale(0.9); filter: brightness(1.5); }
            60% { transform: scale(1.1); filter: brightness(1.8); }
            80% { transform: scale(0.95); filter: brightness(1.3); }
            100% { transform: scale(1); filter: brightness(1); }
        }
        .quest-complete {
            animation: questComplete 0.8s;
        }
        @keyframes questComplete {
            0% { transform: scale(1) rotateX(0deg); opacity: 1; }
            50% { transform: scale(1.1) rotateX(180deg); opacity: 0.5; }
            100% { transform: scale(0) rotateX(360deg); opacity: 0; }
        }
        @keyframes floatIn {
            0% { transform: translateY(-30px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        .glass {
            animation: floatIn 0.6s ease-out;
        }
        .xp-bar-fill {
            background: linear-gradient(90deg, #3b82f6 0%, #60a5fa 50%, #93c5fd 100%);
            height: 100%;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.8), inset 0 0 10px rgba(255, 255, 255, 0.4);
            position: relative;
            overflow: hidden;
        }
        .xp-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
            animation: xpShine 2s infinite;
        }
        @keyframes xpShine {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        /* Reduced animations mode for battery saving */
        .reduce-animations * {
            animation: none !important;
            transition: none !important;
        }
        .reduce-animations .glass::before {
            animation: none !important;
        }
        
        /* === ENHANCEMENT STYLES === */
        
        /* Dark mode */
        body.dark-mode {
            background: linear-gradient(135deg, #000000 0%, #0a0a0a 50%, #111111 100%) !important;
        }
        body.dark-mode .glass {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.95) 0%, rgba(10, 10, 10, 0.95) 100%) !important;
        }
        
        /* Swipe animations */
        .quest-swipeable {
            touch-action: pan-y;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s;
            position: relative;
        }
        .quest-swiping {
            transition: none !important;
        }
        .quest-complete-swipe {
            animation: swipeComplete 0.5s forwards !important;
        }
        @keyframes swipeComplete {
            0% { transform: translateX(0); opacity: 1; }
            100% { transform: translateX(100%); opacity: 0; }
        }
        
        /* Long-press context menu */
        .context-menu {
            position: fixed;
            z-index: 10001;
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.98) 0%, rgba(30, 41, 59, 0.98) 100%);
            backdrop-filter: blur(20px);
            border: 2px solid #60a5fa;
            border-radius: 0.5rem;
            box-shadow: 0 0 30px #3b82f6, 0 8px 32px rgba(0, 0, 0, 0.6);
            padding: 0.5rem;
            min-width: 200px;
            animation: menuPop 0.2s ease-out;
        }
        @keyframes menuPop {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .context-menu-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 0.25rem;
            margin: 0.25rem 0;
        }
        .context-menu-item:hover {
            background: rgba(96, 165, 250, 0.2);
            transform: translateX(5px);
        }
        
        /* Warning indicators */
        @keyframes warningPulse {
            0%, 100% { box-shadow: 0 0 15px #ef4444, 0 0 30px #dc2626; }
            50% { box-shadow: 0 0 25px #ef4444, 0 0 50px #dc2626; }
        }
        .warning-glow {
            animation: warningPulse 1s infinite !important;
            border-color: #ef4444 !important;
        }
        
        /* Bulk select mode */
        .bulk-select-mode {
            border: 2px dashed #60a5fa !important;
            background: rgba(96, 165, 250, 0.05) !important;
        }
        .quest-checkbox {
            width: 22px;
            height: 22px;
            border: 2px solid #60a5fa;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .quest-checkbox.checked {
            background: #60a5fa;
            box-shadow: 0 0 10px #3b82f6;
        }
        .quest-checkbox.checked::after {
            content: '‚úì';
            color: white;
            font-weight: bold;
            font-size: 14px;
        }
        
        /* Quick stats banner */
        .quick-stats-banner {
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.15) 0%, rgba(96, 165, 250, 0.08) 100%);
            border-left: 4px solid #60a5fa;
            animation: slideDown 0.3s ease-out;
        }
        @keyframes slideDown {
            0% { transform: translateY(-20px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        
        /* Settings modal */
        #settingsModal .glass {
            max-height: 85vh;
            overflow-y: auto;
        }
    </style>
</head>
<body class="min-h-screen p-4">
    <!-- Enhanced Settings Modal -->
    <div id="enhancedSettingsModal" class="hidden fixed inset-0 bg-black bg-opacity-80 z-[10000] flex items-center justify-center p-4">
        <div class="glass rounded-lg p-6 max-w-md w-full">
            <h2 class="text-2xl font-bold neon-glow mb-4">‚öôÔ∏è Settings</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-bold mb-2">üåô Background</label>
                    <select id="darkModeSelect" class="w-full bg-gray-800 border-2 border-blue-500 rounded px-3 py-2">
                        <option value="default">Default</option>
                        <option value="dark">Pure Dark (OLED)</option>
                    </select>
                </div>
                
                <div class="border-t border-gray-700 pt-4">
                    <h3 class="font-bold mb-3">‚ö° Auto Features</h3>
                    <label class="flex items-center justify-between cursor-pointer mb-3 p-2 rounded hover:bg-gray-800">
                        <span class="text-sm">Auto-Use Health Potion (HP < 30%)</span>
                        <input type="checkbox" id="autoPotionToggle" class="w-6 h-6">
                    </label>
                    <label class="flex items-center justify-between cursor-pointer mb-3 p-2 rounded hover:bg-gray-800">
                        <span class="text-sm">Fatigue Warning (80%+)</span>
                        <input type="checkbox" id="fatigueWarningToggle" class="w-6 h-6" checked>
                    </label>
                    <label class="flex items-center justify-between cursor-pointer p-2 rounded hover:bg-gray-800">
                        <span class="text-sm">HP Warning (< 30%)</span>
                        <input type="checkbox" id="hpWarningToggle" class="w-6 h-6" checked>
                    </label>
                </div>
            </div>
            
            <button id="closeEnhancedSettings" class="w-full mt-6 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded font-bold">
                üíæ Save & Close
            </button>
        </div>
    </div>

    <div id="app" class="max-w-7xl mx-auto px-2 sm:px-4">
        <!-- Header -->
        <div class="glass rounded-lg p-4 sm:p-6 mb-4">
            <div class="flex justify-between items-center mb-2">
                <div class="text-xs text-gray-500">
                    <button onclick="undoLastAction()" class="px-2 py-1 bg-gray-700 hover:bg-gray-600 text-white rounded text-xs mr-1">‚Ü©Ô∏è</button>
                    <button onclick="resetSystem()" class="px-2 py-1 bg-gray-700 hover:bg-gray-600 text-white rounded text-xs">üîÑ</button>
                </div>
                <div class="flex-1 text-center">
                    <h1 class="text-3xl sm:text-4xl font-black neon-glow text-blue-400" id="rankSymbol">‚öîÔ∏è</h1>
                </div>
                <div>
                    <button id="openEnhancedSettings" class="px-3 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded text-lg">
                        ‚öôÔ∏è
                    </button>
                </div>
            </div>
            
            <!-- Quick Stats Banner -->
            <div id="quickStatsBanner" class="hidden quick-stats-banner rounded-lg p-3 mt-4">
                <div class="flex justify-between items-center text-xs sm:text-sm flex-wrap gap-2">
                    <div>
                        <span class="font-bold text-blue-400">üìä Today:</span>
                        <span id="todayQuests" class="text-green-400 ml-2">0 Quests</span>
                        <span id="todayXP" class="text-yellow-400 ml-2">+0 XP</span>
                        <span id="todayGold" class="text-yellow-400 ml-2">+0 Gold</span>
                    </div>
                    <div>
                        <span class="font-bold text-orange-400">üî• Streak:</span>
                        <span id="streakCounter" class="text-orange-300 ml-2">0 days</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Stats Panel -->
        <div class="glass rounded-lg p-4 sm:p-6 mb-4">
            <div class="text-center mb-4">
                <div class="text-xs sm:text-sm text-gray-400">Hunter Rank</div>
                <div id="levelTitle" class="text-lg sm:text-2xl font-bold text-cyan-400 neon-glow">E-Rank Hunter</div>
                <div id="levelSymbol" class="text-3xl sm:text-4xl mt-2">‚öîÔ∏è</div>
            </div>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-2 sm:gap-4 mb-4">
                <div class="text-center">
                    <div class="text-blue-400 text-xs sm:text-sm">Level</div>
                    <div id="level" class="text-2xl sm:text-3xl font-bold text-white">1</div>
                </div>
                <div class="text-center">
                    <div class="text-blue-400 text-xs sm:text-sm">Gold</div>
                    <div id="gold" class="text-2xl sm:text-3xl font-bold text-yellow-400">500</div>
                </div>
                <div class="text-center">
                    <div class="text-blue-400 text-xs sm:text-sm">Shards</div>
                    <div id="shards" class="text-2xl sm:text-3xl font-bold text-cyan-300">0</div>
                </div>
                <div class="text-center">
                    <div class="text-blue-400 text-xs sm:text-sm">Keys</div>
                    <div id="keys" class="text-2xl sm:text-3xl font-bold text-red-400">0</div>
                </div>
            </div>
            
            <!-- XP Bar -->
            <div class="mb-4">
                <div class="flex justify-between text-xs sm:text-sm text-blue-300 mb-1">
                    <span>Experience</span>
                    <span><span id="currentXP">0</span> / <span id="maxXP">500</span></span>
                </div>
                <div class="w-full bg-gray-900 rounded-full h-3 sm:h-4 overflow-hidden neon-border">
                    <div id="xpBar" class="xp-bar-fill" style="width: 0%"></div>
                </div>
            </div>

            <!-- HP Bar -->
            <div class="mb-4">
                <div class="flex justify-between text-xs sm:text-sm text-red-300 mb-1">
                    <span>Health Points</span>
                    <span><span id="currentHP">100</span> / <span id="maxHP">100</span></span>
                </div>
                <div class="w-full bg-gray-900 rounded-full h-3 sm:h-4 overflow-hidden">
                    <div id="hpBar" class="hp-bar" style="width: 100%"></div>
                </div>
            </div>

            <!-- Fatigue Bar -->
            <div class="mb-4">
                <div class="flex justify-between text-xs sm:text-sm text-orange-300 mb-1">
                    <span>Fatigue</span>
                    <span id="fatiguePercent">0%</span>
                </div>
                <div class="w-full bg-gray-900 rounded-full h-3 sm:h-4 overflow-hidden">
                    <div id="fatigueBar" class="bg-gradient-to-r from-orange-600 to-red-600 h-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
            
            <!-- Combo Counter -->
            <div id="comboDisplay" class="text-center mb-4 hidden">
                <div class="glass rounded p-2 neon-border inline-block">
                    <span class="text-yellow-400 font-bold text-lg">üî• COMBO: <span id="comboCount">0</span>x</span>
                    <span class="text-xs text-cyan-400 ml-2">+<span id="comboBonus">0</span>% Rewards</span>
                </div>
            </div>

            <!-- Stats -->
            <div class="grid grid-cols-4 gap-2 sm:gap-4 mt-4">
                <div class="text-center">
                    <div class="text-red-400 text-xs sm:text-sm">STR</div>
                    <div id="str" class="text-xl sm:text-2xl font-bold text-white">10</div>
                </div>
                <div class="text-center">
                    <div class="text-blue-400 text-xs sm:text-sm">INT</div>
                    <div id="int" class="text-xl sm:text-2xl font-bold text-white">10</div>
                </div>
                <div class="text-center">
                    <div class="text-green-400 text-xs sm:text-sm">AGI</div>
                    <div id="agi" class="text-xl sm:text-2xl font-bold text-white">10</div>
                </div>
                <div class="text-center">
                    <div class="text-blue-300 text-xs sm:text-sm">SEN</div>
                    <div id="sen" class="text-xl sm:text-2xl font-bold text-white">10</div>
                </div>
            </div>
        </div>

        <!-- Mode Toggles -->
        <div class="glass rounded-lg p-2 sm:p-4 mb-4 grid grid-cols-3 gap-2">
            <div class="flex flex-col gap-1">
                <button id="stealthBtn" class="w-full px-2 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded text-xs sm:text-sm">
                    üåë Stealth
                </button>
                <button onclick="event.stopPropagation(); showHelp('stealth');" class="w-full px-1 py-1 bg-gray-800 hover:bg-gray-700 text-xs text-gray-400 rounded">
                    ‚ÑπÔ∏è Info
                </button>
            </div>
            <div class="flex flex-col gap-1">
                <button id="bloodlustBtn" class="w-full px-2 py-2 bg-red-700 hover:bg-red-600 text-white rounded text-xs sm:text-sm">
                    üíÄ Bloodlust
                </button>
                <button onclick="event.stopPropagation(); showHelp('bloodlust');" class="w-full px-1 py-1 bg-gray-800 hover:bg-gray-700 text-xs text-gray-400 rounded">
                    ‚ÑπÔ∏è Info
                </button>
            </div>
            <div class="flex flex-col gap-1">
                <button id="domainBtn" class="w-full px-2 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded text-xs sm:text-sm neon-border">
                    ‚ö° Domain
                </button>
                <button onclick="event.stopPropagation(); showHelp('domain');" class="w-full px-1 py-1 bg-gray-800 hover:bg-gray-700 text-xs text-gray-400 rounded">
                    ‚ÑπÔ∏è Info
                </button>
            </div>
        </div>

        <!-- Tabs -->
        <div class="glass rounded-lg p-2 mb-4 grid grid-cols-3 sm:flex sm:flex-wrap gap-1 sm:gap-2">
            <button class="tab-btn px-2 sm:px-4 py-2 bg-blue-600 text-white rounded text-xs" data-tab="quests">Missions</button>
            <button class="tab-btn px-2 sm:px-4 py-2 bg-gray-700 text-white rounded text-xs" data-tab="rewards">Rewards</button>
            <button class="tab-btn px-2 sm:px-4 py-2 bg-gray-700 text-white rounded text-xs" data-tab="shadows">Army</button>
            <button class="tab-btn px-2 sm:px-4 py-2 bg-gray-700 text-white rounded text-xs" data-tab="store">Shop</button>
            <button class="tab-btn px-2 sm:px-4 py-2 bg-gray-700 text-white rounded text-xs" data-tab="forge">Forge</button>
            <button class="tab-btn px-2 sm:px-4 py-2 bg-gray-700 text-white rounded text-xs" data-tab="evolution">Evolution</button>
            <button class="tab-btn px-2 sm:px-4 py-2 bg-gray-700 text-white rounded text-xs" data-tab="garden">Garden</button>
            <button class="tab-btn px-2 sm:px-4 py-2 bg-gray-700 text-white rounded text-xs" data-tab="skills">Skills</button>
            <button class="tab-btn px-2 sm:px-4 py-2 bg-gray-700 text-white rounded text-xs" data-tab="redgate">Red Gate</button>
            <button class="tab-btn px-2 sm:px-4 py-2 bg-gray-700 text-white rounded text-xs" data-tab="bosses">Bosses</button>
            <button class="tab-btn px-2 sm:px-4 py-2 bg-gray-700 text-white rounded text-xs" data-tab="glitch">Glitch</button>
            <button class="tab-btn px-2 sm:px-4 py-2 bg-gray-700 text-white rounded text-xs" data-tab="achievements">Achieve</button>
            <button class="tab-btn px-2 sm:px-4 py-2 bg-gray-700 text-white rounded text-xs" data-tab="stats">Stats</button>
            <button class="tab-btn px-2 sm:px-4 py-2 bg-gray-700 text-white rounded text-xs" data-tab="settings">Settings</button>
            <button class="tab-btn px-2 sm:px-4 py-2 bg-gray-700 text-white rounded text-xs" data-tab="chronicle">Log</button>
        </div>

        <!-- Content Panels -->
        <div id="content">
            <!-- Quests Panel -->
            <div id="quests" class="content-panel">
                <div class="glass rounded-lg p-4 mb-4">
                    <!-- Quest Controls - Fixed Alignment -->
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <button id="dailyBtn" class="px-4 py-2 bg-blue-600 text-white rounded">Daily</button>
                        <button id="longtermBtn" class="px-4 py-2 bg-gray-700 text-white rounded">Long-Term</button>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <button id="bulkSelectBtn" class="px-3 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded text-sm">‚úì Bulk</button>
                        <button id="sortQuestsBtn" class="px-3 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded text-sm">‚áÖ Sort</button>
                    </div>
                    
                    <!-- Sort Options (hidden by default) -->
                    <div id="sortOptions" class="hidden mb-4 grid grid-cols-3 gap-2">
                        <button class="sort-option px-3 py-1 bg-blue-600 rounded text-sm" data-sort="rank">Rank</button>
                        <button class="sort-option px-3 py-1 bg-gray-700 rounded text-sm" data-sort="time">Time</button>
                        <button class="sort-option px-3 py-1 bg-gray-700 rounded text-sm" data-sort="stat">Stat</button>
                    </div>
                    
                    <!-- Bulk Actions (hidden by default) -->
                    <div id="bulkActions" class="hidden mb-4 flex gap-2">
                        <button id="bulkCompleteBtn" class="flex-1 bg-green-600 hover:bg-green-700 px-4 py-2 rounded font-bold text-sm">‚úì Complete</button>
                        <button id="bulkDeleteBtn" class="flex-1 bg-red-600 hover:bg-red-700 px-4 py-2 rounded font-bold text-sm">‚úó Delete</button>
                        <button id="cancelBulkBtn" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded font-bold text-sm">Cancel</button>
                    </div>
                    
                    <!-- Daily Summary -->
                    <div id="dailySummary" class="hidden bg-gradient-to-r from-green-900/30 to-blue-900/30 border-2 border-green-500 rounded-lg p-3 mb-4">
                        <p class="text-sm font-bold text-center text-green-300"></p>
                    </div>
                    
                    <!-- Quest Input -->
                    <div class="mb-4">
                        <input id="questName" type="text" placeholder="Mission name..." class="w-full bg-gray-800 text-white px-4 py-2 rounded mb-2">
                        <select id="questRank" class="w-full bg-gray-800 text-white px-4 py-2 rounded mb-2">
                            <option value="E">E-Rank</option>
                            <option value="D">D-Rank</option>
                            <option value="C">C-Rank</option>
                            <option value="B">B-Rank</option>
                            <option value="A">A-Rank</option>
                            <option value="S">S-Rank</option>
                        </select>
                        <select id="questStatType" class="w-full bg-gray-800 text-white px-4 py-2 rounded mb-2">
                            <option value="none">No Stat Bonus</option>
                            <option value="str">Strength (+Physical Tasks: Push-ups, Exercise, etc.)</option>
                            <option value="int">Intelligence (+Mental Tasks: Reading, Learning, etc.)</option>
                            <option value="agi">Agility (+Speed Tasks: Running, Quick Actions, etc.)</option>
                            <option value="sen">Sense (+Awareness Tasks: Meditation, Early Wake, etc.)</option>
                        </select>
                        <textarea id="questNotes" placeholder="Quest notes (optional)..." class="w-full bg-gray-800 text-white px-4 py-2 rounded mb-2 text-sm" rows="2"></textarea>
                        
                        <!-- Auto-save as template option -->
                        <label class="flex items-center gap-2 mb-2 text-sm text-gray-300 cursor-pointer">
                            <input type="checkbox" id="autoSaveTemplate" class="w-4 h-4 cursor-pointer">
                            <span>üíæ Also save as template (for recurring quests)</span>
                        </label>
                        
                        <button id="addQuest" class="w-full bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded neon-border">
                            + Add Mission
                        </button>
                    </div>
                    
                    <div id="questList" class="space-y-2"></div>
                    
                    <!-- Quest History -->
                    <div class="mt-6 pt-6 border-t border-gray-700">
                        <h3 class="font-bold mb-2 text-sm text-gray-400">üìú Recent Completions (Last 10)</h3>
                        <div id="questHistory" class="space-y-1 text-sm"></div>
                    </div>
                </div>
                
                <!-- Quest Chains Panel -->
                <div class="glass rounded-lg p-4 mb-4">
                    <h3 class="text-lg font-bold text-purple-400 mb-3">
                        ‚õìÔ∏è Quest Chains <button onclick="showHelp('chains')" class="text-xs bg-purple-600 px-2 py-1 rounded ml-2">‚ÑπÔ∏è</button>
                    </h3>
                    <p class="text-xs text-gray-400 mb-3">Complete quests consistently to unlock higher levels and permanent buffs!</p>
                    
                    <div id="questChainsList" class="space-y-2"></div>
                    
                    <div class="mt-3 text-xs text-gray-500">
                        üí° Tip: Complete the same quest 7 days in a row to level up your chain!
                    </div>
                </div>
                
                <!-- Saved Quest Templates -->
                <div class="glass rounded-lg p-4">
                    <h3 class="text-lg font-bold text-cyan-400 mb-3">
                        Quest Templates <button onclick="showHelp('templates')" class="text-xs bg-cyan-600 px-2 py-1 rounded ml-2">‚ÑπÔ∏è</button>
                    </h3>
                    <p class="text-xs text-gray-400 mb-3">Save your frequent quests for quick re-adding</p>
                    
                    <div class="flex gap-2 mb-3">
                        <button onclick="saveCurrentQuest()" class="flex-1 bg-green-600 hover:bg-green-500 text-white px-3 py-2 rounded text-sm">
                            üíæ Save Last Added Quest
                        </button>
                    </div>
                    
                    <div id="savedQuestsList" class="space-y-2"></div>
                </div>
                
                <!-- Emergency Quest Panel -->
                <div id="emergencyQuestPanel" class="glass rounded-lg p-4 hidden glitch-gate">
                    <h3 class="text-2xl font-bold text-red-400 mb-3 neon-glow">‚ö†Ô∏è EMERGENCY QUEST</h3>
                    <div id="emergencyQuestContent"></div>
                </div>
            </div>

            <!-- Daily Rewards & Job Class Panel -->
            <div id="rewards" class="content-panel hidden">
                <div class="glass rounded-lg p-4 mb-4">
                    <h2 class="text-2xl font-bold text-blue-400 mb-4">Daily Login Rewards</h2>
                    <p class="text-gray-300 text-sm mb-4">Login streak: <span id="loginStreak" class="text-cyan-400 font-bold">0</span> days</p>
                    
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-3" id="loginRewardsList"></div>
                </div>
                
                <div class="glass rounded-lg p-4" id="jobClassPanel">
                    <h2 class="text-2xl font-bold text-blue-400 mb-4">Job Class System</h2>
                    <p class="text-gray-300 text-sm mb-4" id="jobClassStatus">Unlock at Level 40</p>
                    <div id="jobClassOptions" class="hidden space-y-3"></div>
                </div>
            </div>

            <!-- Shadow Army Panel -->
            <div id="shadows" class="content-panel hidden">
                <div class="glass rounded-lg p-4 mb-4">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-blue-400">Shadow Legion</h2>
                        <div class="text-cyan-300">Army Power: <span id="armyPower">0</span></div>
                    </div>
                    <div id="shadowList" class="space-y-2"></div>
                    <div class="mt-4 text-sm text-gray-400">Passive Income: +<span id="passiveIncome">0</span> Gold per 5s</div>
                </div>
            </div>

            <!-- Store Panel -->
            <div id="store" class="content-panel hidden">
                <div class="glass rounded-lg p-4 mb-4">
                    <h2 class="text-2xl font-bold text-blue-400 mb-4">The Reliquary <button onclick="showHelp('store')" class="text-sm bg-cyan-600 px-2 py-1 rounded ml-2">‚ÑπÔ∏è Info</button></h2>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <!-- Soul Shards -->
                        <div class="glass rounded p-4 neon-border">
                            <h3 class="text-cyan-300 font-bold mb-2">Soul Shard</h3>
                            <p class="text-gray-300 text-xs mb-2">Basic crafting material</p>
                            <div class="flex justify-between items-center">
                                <span class="text-yellow-400">100 Gold</span>
                                <button class="buy-shard px-3 py-1 bg-blue-600 hover:bg-blue-500 rounded text-sm">Buy</button>
                            </div>
                        </div>
                        
                        <div class="glass rounded p-4 neon-border">
                            <h3 class="text-cyan-300 font-bold mb-2">Soul Shard x10</h3>
                            <p class="text-gray-300 text-xs mb-2">Bulk purchase</p>
                            <div class="flex justify-between items-center">
                                <span class="text-yellow-400">900 Gold</span>
                                <button class="buy-shard-10 px-3 py-1 bg-blue-600 hover:bg-blue-500 rounded text-sm">Buy</button>
                            </div>
                        </div>
                        
                        <!-- Health Potion -->
                        <div class="glass rounded p-3">
                            <h3 class="text-red-400 font-bold text-sm mb-1">Health Potion</h3>
                            <p class="text-xs text-green-300">‚úì +30 HP</p>
                            <p class="text-xs text-red-300 mb-2">‚úó +5% Fatigue</p>
                            <div class="text-xs text-gray-300 mb-2">Owned: <span id="healthPotionCount">0</span></div>
                            <button onclick="buyPotion('healthPotion', 50)" class="w-full bg-red-600 hover:bg-red-500 text-white px-2 py-1 rounded text-xs">
                                Buy (50 Gold)
                            </button>
                        </div>
                        
                        <!-- Stamina Potion -->
                        <div class="glass rounded p-3">
                            <h3 class="text-orange-400 font-bold text-sm mb-1">Stamina Potion</h3>
                            <p class="text-xs text-green-300">‚úì -25% Fatigue</p>
                            <p class="text-xs text-red-300 mb-2">‚úó -10 HP</p>
                            <div class="text-xs text-gray-300 mb-2">Owned: <span id="fatiguePotionCount">0</span></div>
                            <button onclick="buyPotion('fatiguePotion', 75)" class="w-full bg-orange-600 hover:bg-orange-500 text-white px-2 py-1 rounded text-xs">
                                Buy (75 Gold)
                            </button>
                        </div>
                        
                        <!-- XP Elixir -->
                        <div class="glass rounded p-3">
                            <h3 class="text-purple-400 font-bold text-sm mb-1">XP Elixir</h3>
                            <p class="text-xs text-green-300">‚úì +50 XP</p>
                            <p class="text-xs text-red-300 mb-2">‚úó +10% Fatigue</p>
                            <div class="text-xs text-gray-300 mb-2">Owned: <span id="xpPotionCount">0</span></div>
                            <button onclick="buyPotion('xpPotion', 100)" class="w-full bg-purple-600 hover:bg-purple-500 text-white px-2 py-1 rounded text-xs">
                                Buy (100 Gold)
                            </button>
                        </div>
                        
                        <!-- Cursed Potion -->
                        <div class="glass rounded p-3 border-2 border-red-500">
                            <h3 class="text-red-400 font-bold text-sm mb-1">Cursed Potion ‚ö†Ô∏è</h3>
                            <p class="text-xs text-green-300">‚úì +100 XP, +50 Gold</p>
                            <p class="text-xs text-red-300 mb-2">‚úó -20 HP, +15% Fatigue</p>
                            <div class="text-xs text-gray-300 mb-2">Owned: <span id="cursedPotionCount">0</span></div>
                            <button onclick="buyPotion('cursedPotion', 150)" class="w-full bg-red-700 hover:bg-red-600 text-white px-2 py-1 rounded text-xs">
                                Buy (150 Gold)
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Potion Usage -->
                <div class="glass rounded-lg p-4">
                    <h3 class="text-lg font-bold text-cyan-400 mb-3">Use Potions</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="usePotion('healthPotion')" class="bg-red-600 hover:bg-red-500 text-white px-3 py-2 rounded text-sm">
                            üß™ Health
                        </button>
                        <button onclick="usePotion('fatiguePotion')" class="bg-orange-600 hover:bg-orange-500 text-white px-3 py-2 rounded text-sm">
                            üß™ Stamina
                        </button>
                        <button onclick="usePotion('xpPotion')" class="bg-purple-600 hover:bg-purple-500 text-white px-3 py-2 rounded text-sm">
                            üß™ XP Elixir
                        </button>
                        <button onclick="usePotion('cursedPotion')" class="bg-red-700 hover:bg-red-600 text-white px-3 py-2 rounded text-sm">
                            ‚ö†Ô∏è Cursed
                        </button>
                    </div>
                </div>
            </div>

            <!-- Forge Panel -->
            <div id="forge" class="content-panel hidden">
                <div class="glass rounded-lg p-4 mb-4">
                    <h2 class="text-2xl font-bold text-blue-400 mb-4">The Forge</h2>
                    <div class="mb-4">
                        <input id="gearName" type="text" placeholder="Shadow Gear name..." class="w-full bg-gray-800 text-white px-4 py-2 rounded mb-2">
                        <input id="gearPower" type="number" placeholder="Power (1-100)" class="w-full bg-gray-800 text-white px-4 py-2 rounded mb-2">
                        <button id="craftGear" class="w-full bg-cyan-600 hover:bg-cyan-500 text-white px-4 py-2 rounded neon-border">
                            Forge Shadow Gear (5 Shards)
                        </button>
                    </div>
                    <div id="gearList" class="space-y-2"></div>
                </div>

                <div class="glass rounded-lg p-4">
                    <h2 class="text-2xl font-bold text-blue-400 mb-4">Shadow Fusion</h2>
                    <p class="text-gray-300 text-sm mb-4">Merge two shadows to create a General-grade shadow</p>
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <select id="fusionShadow1" class="bg-gray-800 text-white px-4 py-2 rounded">
                            <option value="">Select Shadow 1</option>
                        </select>
                        <select id="fusionShadow2" class="bg-gray-800 text-white px-4 py-2 rounded">
                            <option value="">Select Shadow 2</option>
                        </select>
                    </div>
                    <button id="fuseShadows" class="w-full bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded neon-border">
                        ‚ö° Fuse Shadows
                    </button>
                </div>
            </div>

            <!-- Evolution Tree Panel -->
            <div id="evolution" class="content-panel hidden">
                <div class="glass rounded-lg p-4 mb-4">
                    <h2 class="text-2xl font-bold text-blue-400 mb-4">Shadow Evolution Tree</h2>
                    <p class="text-gray-300 text-sm mb-4">Spend Shards to unlock permanent stat bonuses</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="glass rounded p-4">
                            <h3 class="text-red-400 font-bold mb-2">Strength Path</h3>
                            <p class="text-sm text-gray-300 mb-2">Level <span id="strEvolution">0</span>/10</p>
                            <p class="text-xs text-gray-400 mb-3">+5 STR per level</p>
                            <button onclick="upgradeEvolution('str')" class="w-full bg-red-600 hover:bg-red-500 text-white px-3 py-2 rounded text-sm">
                                Upgrade (10 Shards)
                            </button>
                        </div>
                        
                        <div class="glass rounded p-4">
                            <h3 class="text-blue-400 font-bold mb-2">Intelligence Path</h3>
                            <p class="text-sm text-gray-300 mb-2">Level <span id="intEvolution">0</span>/10</p>
                            <p class="text-xs text-gray-400 mb-3">+5 INT per level</p>
                            <button onclick="upgradeEvolution('int')" class="w-full bg-blue-600 hover:bg-blue-500 text-white px-3 py-2 rounded text-sm">
                                Upgrade (10 Shards)
                            </button>
                        </div>
                        
                        <div class="glass rounded p-4">
                            <h3 class="text-green-400 font-bold mb-2">Agility Path</h3>
                            <p class="text-sm text-gray-300 mb-2">Level <span id="agiEvolution">0</span>/10</p>
                            <p class="text-xs text-gray-400 mb-3">+5 AGI per level</p>
                            <button onclick="upgradeEvolution('agi')" class="w-full bg-green-600 hover:bg-green-500 text-white px-3 py-2 rounded text-sm">
                                Upgrade (10 Shards)
                            </button>
                        </div>
                        
                        <div class="glass rounded p-4">
                            <h3 class="text-purple-400 font-bold mb-2">Sense Path</h3>
                            <p class="text-sm text-gray-300 mb-2">Level <span id="senEvolution">0</span>/10</p>
                            <p class="text-xs text-gray-400 mb-3">+5 SEN per level</p>
                            <button onclick="upgradeEvolution('sen')" class="w-full bg-purple-600 hover:bg-purple-500 text-white px-3 py-2 rounded text-sm">
                                Upgrade (10 Shards)
                            </button>
                        </div>
                        
                        <div class="glass rounded p-4">
                            <h3 class="text-yellow-400 font-bold mb-2">Gold Mastery</h3>
                            <p class="text-sm text-gray-300 mb-2">Level <span id="goldEvolution">0</span>/10</p>
                            <p class="text-xs text-gray-400 mb-3">+10% Gold per level</p>
                            <button onclick="upgradeEvolution('goldBonus')" class="w-full bg-yellow-600 hover:bg-yellow-500 text-white px-3 py-2 rounded text-sm">
                                Upgrade (15 Shards)
                            </button>
                        </div>
                        
                        <div class="glass rounded p-4">
                            <h3 class="text-cyan-400 font-bold mb-2">XP Mastery</h3>
                            <p class="text-sm text-gray-300 mb-2">Level <span id="xpEvolution">0</span>/10</p>
                            <p class="text-xs text-gray-400 mb-3">+10% XP per level</p>
                            <button onclick="upgradeEvolution('xpBonus')" class="w-full bg-cyan-600 hover:bg-cyan-500 text-white px-3 py-2 rounded text-sm">
                                Upgrade (15 Shards)
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Shadow Garden Panel -->
            <div id="garden" class="content-panel hidden">
                <div class="glass rounded-lg p-4">
                    <h2 class="text-2xl font-bold text-blue-400 mb-4">Shadow Garden</h2>
                    <p class="text-gray-300 text-sm mb-4">Your shadows passively farm gold while the app is open</p>
                    
                    <div class="glass rounded p-4 mb-4 neon-border">
                        <div class="text-center mb-4">
                            <div class="text-sm text-gray-400">Garden Status</div>
                            <div id="gardenStatus" class="text-2xl font-bold text-cyan-400">Inactive</div>
                        </div>
                        <div class="text-center mb-4">
                            <div class="text-sm text-gray-400">Gold Accumulated</div>
                            <div id="gardenGold" class="text-3xl font-bold text-yellow-400">0</div>
                        </div>
                        <button id="activateGarden" onclick="activateGarden()" class="w-full bg-green-600 hover:bg-green-500 text-white px-4 py-3 rounded font-bold mb-2">
                            üå± Activate Garden (50 Shards)
                        </button>
                        <button id="collectGarden" onclick="collectGarden()" class="w-full bg-blue-600 hover:bg-blue-500 text-white px-4 py-3 rounded font-bold" disabled>
                            üí∞ Collect Gold
                        </button>
                    </div>
                    
                    <div class="text-sm text-gray-400">
                        <p>‚Ä¢ Garden generates <span class="text-cyan-400">5 gold per shadow</span> every 10 seconds</p>
                        <p>‚Ä¢ Must remain on this tab to accumulate</p>
                        <p>‚Ä¢ One-time activation cost</p>
                    </div>
                </div>
            </div>

            <!-- Monarch Skills Panel -->
            <div id="skills" class="content-panel hidden">
                <div class="glass rounded-lg p-4">
                    <h2 class="text-2xl font-bold text-blue-400 mb-4">Monarch's Skills</h2>
                    <p class="text-gray-300 text-sm mb-4">Unlock powerful active abilities</p>
                    
                    <div class="space-y-3">
                        <div class="glass rounded p-4">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="text-purple-400 font-bold">Mutilate</h3>
                                <span class="text-yellow-400">Cost: 100 Shards</span>
                            </div>
                            <p class="text-sm text-gray-300 mb-3">Deal massive damage to world bosses (3x your STR)</p>
                            <button onclick="unlockSkill('mutilate')" class="w-full bg-purple-600 hover:bg-purple-500 text-white px-3 py-2 rounded text-sm">
                                Unlock
                            </button>
                        </div>
                        
                        <div class="glass rounded p-4">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="text-red-400 font-bold">Dragon's Breath</h3>
                                <span class="text-yellow-400">Cost: 150 Shards</span>
                            </div>
                            <p class="text-sm text-gray-300 mb-3">Clear 50% fatigue instantly</p>
                            <button onclick="unlockSkill('dragons_breath')" class="w-full bg-red-600 hover:bg-red-500 text-white px-3 py-2 rounded text-sm">
                                Unlock
                            </button>
                        </div>
                        
                        <div class="glass rounded p-4">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="text-cyan-400 font-bold">Ruler's Authority</h3>
                                <span class="text-yellow-400">Cost: 200 Shards</span>
                            </div>
                            <p class="text-sm text-gray-300 mb-3">2x XP and Gold for 1 hour (drains 20% fatigue)</p>
                            <button onclick="unlockSkill('rulers_authority')" class="w-full bg-cyan-600 hover:bg-cyan-500 text-white px-3 py-2 rounded text-sm">
                                Unlock
                            </button>
                        </div>
                    </div>
                    
                    <div id="activeSkills" class="mt-6">
                        <h3 class="text-blue-400 font-bold mb-3">Active Skills</h3>
                        <div id="skillList" class="space-y-2"></div>
                    </div>
                </div>
            </div>

            <!-- Red Gate Raids Panel -->
            <div id="redgate" class="content-panel hidden">
                <div class="glass rounded-lg p-4">
                    <h2 class="text-2xl font-bold text-red-400 mb-4">Red Gate Raids</h2>
                    <p class="text-gray-300 text-sm mb-4">Send shadows on idle missions to earn rewards</p>
                    
                    <div class="mb-4">
                        <select id="raidShadow" class="w-full bg-gray-800 text-white px-4 py-2 rounded mb-2">
                            <option value="">Select Shadow</option>
                        </select>
                        <select id="raidDifficulty" class="w-full bg-gray-800 text-white px-4 py-2 rounded mb-2">
                            <option value="easy">Easy Gate (1 hour, 100 gold)</option>
                            <option value="medium">Medium Gate (3 hours, 500 gold)</option>
                            <option value="hard">Hard Gate (6 hours, 1500 gold)</option>
                            <option value="nightmare">Nightmare Gate (12 hours, 5000 gold + 10 shards)</option>
                        </select>
                        <button onclick="startRaid()" class="w-full bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded neon-border">
                            üö™ Deploy Shadow
                        </button>
                    </div>
                    
                    <div id="activeRaids">
                        <h3 class="text-red-400 font-bold mb-3">Active Raids</h3>
                        <div id="raidList" class="space-y-2"></div>
                    </div>
                </div>
            </div>

            <!-- World Bosses Panel -->
            <div id="bosses" class="content-panel hidden">
                <div class="glass rounded-lg p-4">
                    <h2 class="text-2xl font-bold text-red-400 mb-4">World Bosses</h2>
                    <div id="bossContainer">
                        <p class="text-gray-400 text-center py-8">No world boss available. Reach level 10 to unlock.</p>
                    </div>
                </div>
            </div>

            <!-- Glitch Gates Panel -->
            <div id="glitch" class="content-panel hidden">
                <div class="glass rounded-lg p-4">
                    <h2 class="text-2xl font-bold text-red-400 mb-4">Glitch Gates</h2>
                    <div id="glitchContainer">
                        <p class="text-gray-400 text-center py-8">No Glitch Gates available. Acquire Architect's Keys from S-Rank missions.</p>
                    </div>
                </div>
            </div>

            <!-- Achievements Panel -->
            <div id="achievements" class="content-panel hidden">
                <div class="glass rounded-lg p-4">
                    <h2 class="text-2xl font-bold text-blue-400 mb-4">Secret Achievements</h2>
                    <p class="text-gray-300 text-sm mb-4">Unlock hidden goals for permanent bonuses</p>
                    
                    <div id="achievementList" class="space-y-3"></div>
                </div>
            </div>

            <!-- Statistics Panel -->
            <div id="stats" class="content-panel hidden">
                <div class="glass rounded-lg p-4 mb-4">
                    <h2 class="text-2xl font-bold text-blue-400 mb-4">Lifetime Statistics</h2>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="glass rounded p-3 text-center">
                            <div class="text-cyan-400 text-sm">Quests Completed</div>
                            <div id="totalQuests" class="text-3xl font-bold text-white">0</div>
                        </div>
                        <div class="glass rounded p-3 text-center">
                            <div class="text-cyan-400 text-sm">Total XP Earned</div>
                            <div id="totalXP" class="text-3xl font-bold text-white">0</div>
                        </div>
                        <div class="glass rounded p-3 text-center">
                            <div class="text-cyan-400 text-sm">Total Gold Earned</div>
                            <div id="totalGold" class="text-3xl font-bold text-yellow-400">0</div>
                        </div>
                        <div class="glass rounded p-3 text-center">
                            <div class="text-cyan-400 text-sm">Success Rate</div>
                            <div id="successRate" class="text-3xl font-bold text-green-400">100%</div>
                        </div>
                    </div>
                    
                    <div class="glass rounded p-4 mb-4">
                        <h3 class="text-lg font-bold text-blue-400 mb-3">Records</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-400">Longest Login Streak:</span>
                                <span id="longestStreak" class="text-cyan-400 font-bold">0 days</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Highest Combo:</span>
                                <span id="highestCombo" class="text-yellow-400 font-bold">0x</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Shadows Extracted:</span>
                                <span id="shadowsExtracted" class="text-purple-400 font-bold">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Bosses Defeated:</span>
                                <span id="bossesDefeated" class="text-red-400 font-bold">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Emergency Quests:</span>
                                <span id="emergencyCompleted" class="text-orange-400 font-bold">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="glass rounded p-4">
                        <h3 class="text-lg font-bold text-blue-400 mb-3">Stat Distribution</h3>
                        <div class="space-y-2">
                            <div>
                                <div class="flex justify-between text-xs mb-1">
                                    <span class="text-red-400">STR Quests</span>
                                    <span id="strQuestCount" class="text-white">0</span>
                                </div>
                                <div class="w-full bg-gray-800 rounded-full h-2">
                                    <div id="strQuestBar" class="bg-red-500 h-full rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between text-xs mb-1">
                                    <span class="text-blue-400">INT Quests</span>
                                    <span id="intQuestCount" class="text-white">0</span>
                                </div>
                                <div class="w-full bg-gray-800 rounded-full h-2">
                                    <div id="intQuestBar" class="bg-blue-500 h-full rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between text-xs mb-1">
                                    <span class="text-green-400">AGI Quests</span>
                                    <span id="agiQuestCount" class="text-white">0</span>
                                </div>
                                <div class="w-full bg-gray-800 rounded-full h-2">
                                    <div id="agiQuestBar" class="bg-green-500 h-full rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between text-xs mb-1">
                                    <span class="text-purple-400">SEN Quests</span>
                                    <span id="senQuestCount" class="text-white">0</span>
                                </div>
                                <div class="w-full bg-gray-800 rounded-full h-2">
                                    <div id="senQuestBar" class="bg-purple-500 h-full rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Panel -->
            <div id="settings" class="content-panel hidden">
                <div class="glass rounded-lg p-4 mb-4">
                    <h2 class="text-2xl font-bold text-blue-400 mb-4">Settings</h2>
                    
                    <div class="space-y-4">
                        <!-- Voice Settings -->
                        <div class="glass rounded p-4">
                            <h3 class="text-lg font-bold text-cyan-400 mb-3">Audio</h3>
                            <div class="flex justify-between items-center mb-3">
                                <span class="text-gray-300">Voice Notifications</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="voiceToggle" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                            <button onclick="testVoice()" class="w-full bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded text-sm">
                                Test Voice
                            </button>
                        </div>
                        
                        <!-- Performance Settings -->
                        <div class="glass rounded p-4">
                            <h3 class="text-lg font-bold text-cyan-400 mb-3">Performance</h3>
                            <div class="flex justify-between items-center mb-3">
                                <span class="text-gray-300">Animations</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="animationsToggle" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                            <div class="text-xs text-gray-400">Disable to save battery on mobile</div>
                        </div>
                        
                        <!-- Data Management -->
                        <div class="glass rounded p-4">
                            <h3 class="text-lg font-bold text-cyan-400 mb-3">Data Management</h3>
                            <div class="space-y-2">
                                <button onclick="exportSaveData()" class="w-full bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded">
                                    üì• Export Save Data
                                </button>
                                <button onclick="document.getElementById('importFile').click()" class="w-full bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded">
                                    üì§ Import Save Data
                                </button>
                                <input type="file" id="importFile" accept=".json" style="display: none" onchange="importSaveData(event)">
                                <button onclick="clearAllData()" class="w-full bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded">
                                    üóëÔ∏è Clear All Data
                                </button>
                            </div>
                            <div class="text-xs text-gray-400 mt-2">
                                Backup your progress regularly! Export saves to your device.
                            </div>
                        </div>
                        
                        <!-- About -->
                        <div class="glass rounded p-4">
                            <h3 class="text-lg font-bold text-cyan-400 mb-3">About</h3>
                            <div class="text-sm text-gray-300 space-y-1">
                                <p><strong>Version:</strong> 43.0 Ultimate Edition</p>
                                <p><strong>Features:</strong> 15 tabs, Weather API, Voice AI</p>
                                <p><strong>Save Location:</strong> Local Storage</p>
                                <p class="text-xs text-gray-500 mt-2">Inspired by Solo Leveling</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chronicle Panel -->
            <div id="chronicle" class="content-panel hidden">
                <div class="glass rounded-lg p-4 mb-4">
                    <h2 class="text-2xl font-bold text-blue-400 mb-4">Monarch's Log</h2>
                    <div class="mb-4">
                        <textarea id="logEntry" placeholder="Record your journey..." class="w-full bg-gray-800 text-white px-4 py-2 rounded h-24"></textarea>
                        <button id="addLog" class="w-full bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded mt-2">
                            Add Entry
                        </button>
                    </div>
                    <div id="logList" class="space-y-2 max-h-96 overflow-y-auto"></div>
                </div>
                
                <div class="glass rounded-lg p-4">
                    <button id="exportJourney" class="w-full bg-cyan-600 hover:bg-cyan-500 text-white px-4 py-2 rounded neon-border">
                        üìú Export Journey
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Audio Context for Sound Effects
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playSound(type) {
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            if (type === 'arise') {
                oscillator.type = 'sawtooth';
                oscillator.frequency.setValueAtTime(80, audioCtx.currentTime);
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
                oscillator.start(audioCtx.currentTime);
                oscillator.stop(audioCtx.currentTime + 0.5);
            } else if (type === 'levelup') {
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(440, audioCtx.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(880, audioCtx.currentTime + 0.3);
                gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                oscillator.start(audioCtx.currentTime);
                oscillator.stop(audioCtx.currentTime + 0.3);
            } else if (type === 'domain') {
                oscillator.type = 'sawtooth';
                oscillator.frequency.setValueAtTime(60, audioCtx.currentTime);
                gainNode.gain.setValueAtTime(0.4, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 1);
                oscillator.start(audioCtx.currentTime);
                oscillator.stop(audioCtx.currentTime + 1);
            }
        }

        // Game State
        let gameState = {
            level: 1,
            xp: 0,
            gold: 500,
            shards: 0,
            keys: 0,
            fatigue: 0,
            str: 10,
            int: 10,
            agi: 10,
            sen: 10,
            quests: [],
            questMode: 'daily',
            shadows: [],
            gear: [],
            logs: [],
            penaltyUntil: null,
            currentBoss: null,
            glitchGates: [],
            stealthMode: false,
            bloodlustMode: false,
            domainActive: false,
            lastResetDate: new Date().toDateString(), // Initialize to today, not null!
            // New enhancement features
            questHistory: [],
            todayXP: 0,
            todayGold: 0,
            todayCompleted: 0,
            streakDays: 0,
            lastCompletionDate: null,
            bulkSelectMode: false,
            selectedQuests: new Set(),
            questSort: 'rank',
            enhancedSettings: {
                darkMode: false,
                accentColor: 'blue',
                fontSize: 'medium',
                autoPotion: false,
                fatigueWarning: true,
                hpWarning: true
            },
            // Existing features
            achievements: [],
            evolutionTree: {
                str: 0,
                int: 0,
                agi: 0,
                sen: 0,
                critChance: 0,
                goldBonus: 0,
                xpBonus: 0
            },
            shadowGarden: {
                active: false,
                goldGenerated: 0,
                lastCollected: null
            },
            monarchSkills: [],
            shadowCommander: null,
            artifacts: [],
            playerClass: 'Shadow Monarch',
            classUnlocked: false,
            redGateRaids: [],
            ascensionLevel: 0,
            goldMultiplier: 1,
            xpMultiplier: 1,
            uiTheme: 'default',
            actionHistory: [],
            emergencyQuest: null,
            lastEmergencyCheck: null,
            userLocation: null, // For weather API
            lastWeatherCheck: null,
            // New Solo Leveling features
            hp: 100,
            maxHP: 100,
            lastLoginDate: null,
            loginStreak: 0,
            loginRewardsClaimed: [],
            comboCount: 0,
            lastQuestCompleteTime: null,
            jobClass: null,
            jobClassUnlockedAt: null,
            voiceEnabled: true,
            // Statistics
            stats: {
                totalQuestsCompleted: 0,
                totalQuestsFailed: 0,
                totalXPEarned: 0,
                totalGoldEarned: 0,
                longestLoginStreak: 0,
                highestCombo: 0,
                shadowsExtracted: 0,
                bossesDefeated: 0,
                emergencyQuestsCompleted: 0,
                strQuests: 0,
                intQuests: 0,
                agiQuests: 0,
                senQuests: 0
            },
            // Potions and saved quests
            potions: {
                healthPotion: 0,
                fatiguePotion: 0,
                xpPotion: 0,
                cursedPotion: 0
            },
            savedQuests: [],
            // QUEST CHAIN SYSTEM
            questChains: {
                // Example: 'pushups': { level: 1, streak: 0, lastCompleted: null }
            },
            permanentBuffs: {
                str: 0,
                int: 0,
                agi: 0,
                sen: 0
            }
        };

        // Quest Chain Templates (Progressive Difficulty)
        const chainTemplates = {
            'pushups': {
                statType: 'str',
                levels: [
                    { count: 10, name: '10 Pushups', bonus: 1 },
                    { count: 20, name: '20 Pushups', bonus: 2 },
                    { count: 30, name: '30 Pushups', bonus: 3 },
                    { count: 40, name: '40 Pushups', bonus: 4 },
                    { count: 50, name: '50 Pushups (Master)', bonus: 10 }
                ],
                maxLevel: 5,
                weeksRequired: 1, // 1 week of consistency to level up
                finalReward: 'Pushup Master: Permanent +10 STR'
            },
            'running': {
                statType: 'agi',
                levels: [
                    { count: 1, name: 'Run 1km', bonus: 1 },
                    { count: 2, name: 'Run 2km', bonus: 2 },
                    { count: 3, name: 'Run 3km', bonus: 3 },
                    { count: 5, name: 'Run 5km', bonus: 5 },
                    { count: 10, name: 'Run 10km (Master)', bonus: 10 }
                ],
                maxLevel: 5,
                weeksRequired: 1,
                finalReward: 'Running Master: Permanent +10 AGI'
            },
            'reading': {
                statType: 'int',
                levels: [
                    { count: 15, name: 'Read 15 min', bonus: 1 },
                    { count: 30, name: 'Read 30 min', bonus: 2 },
                    { count: 45, name: 'Read 45 min', bonus: 3 },
                    { count: 60, name: 'Read 1 hour', bonus: 4 },
                    { count: 90, name: 'Read 90 min (Master)', bonus: 10 }
                ],
                maxLevel: 5,
                weeksRequired: 1,
                finalReward: 'Scholar: Permanent +10 INT'
            },
            'meditation': {
                statType: 'sen',
                levels: [
                    { count: 5, name: 'Meditate 5 min', bonus: 1 },
                    { count: 10, name: 'Meditate 10 min', bonus: 2 },
                    { count: 15, name: 'Meditate 15 min', bonus: 3 },
                    { count: 20, name: 'Meditate 20 min', bonus: 4 },
                    { count: 30, name: 'Meditate 30 min (Master)', bonus: 10 }
                ],
                maxLevel: 5,
                weeksRequired: 1,
                finalReward: 'Zen Master: Permanent +10 SEN'
            },
            'study': {
                statType: 'int',
                levels: [
                    { count: 30, name: 'Study 30 min', bonus: 1 },
                    { count: 60, name: 'Study 1 hour', bonus: 2 },
                    { count: 90, name: 'Study 90 min', bonus: 3 },
                    { count: 120, name: 'Study 2 hours', bonus: 5 },
                    { count: 180, name: 'Study 3 hours (Master)', bonus: 10 }
                ],
                maxLevel: 5,
                weeksRequired: 1,
                finalReward: 'Study Master: Permanent +10 INT'
            },
            'workout': {
                statType: 'str',
                levels: [
                    { count: 15, name: 'Workout 15 min', bonus: 1 },
                    { count: 30, name: 'Workout 30 min', bonus: 2 },
                    { count: 45, name: 'Workout 45 min', bonus: 3 },
                    { count: 60, name: 'Workout 1 hour', bonus: 5 },
                    { count: 90, name: 'Workout 90 min (Master)', bonus: 10 }
                ],
                maxLevel: 5,
                weeksRequired: 1,
                finalReward: 'Fitness Master: Permanent +10 STR'
            }
        };

        // Cache frequently accessed DOM elements for better performance
        const domCache = {
            level: null,
            gold: null,
            shards: null,
            keys: null,
            str: null,
            int: null,
            agi: null,
            sen: null,
            currentHP: null,
            maxHP: null,
            hpBar: null,
            currentXP: null,
            maxXP: null,
            xpBar: null,
            fatiguePercent: null,
            fatigueBar: null,
            levelTitle: null,
            levelSymbol: null,
            rankSymbol: null
        };

        // Initialize DOM cache after page load
        function initDomCache() {
            domCache.level = document.getElementById('level');
            domCache.gold = document.getElementById('gold');
            domCache.shards = document.getElementById('shards');
            domCache.keys = document.getElementById('keys');
            domCache.str = document.getElementById('str');
            domCache.int = document.getElementById('int');
            domCache.agi = document.getElementById('agi');
            domCache.sen = document.getElementById('sen');
            domCache.currentHP = document.getElementById('currentHP');
            domCache.maxHP = document.getElementById('maxHP');
            domCache.hpBar = document.getElementById('hpBar');
            domCache.currentXP = document.getElementById('currentXP');
            domCache.maxXP = document.getElementById('maxXP');
            domCache.xpBar = document.getElementById('xpBar');
            domCache.fatiguePercent = document.getElementById('fatiguePercent');
            domCache.fatigueBar = document.getElementById('fatigueBar');
            domCache.levelTitle = document.getElementById('levelTitle');
            domCache.levelSymbol = document.getElementById('levelSymbol');
            domCache.rankSymbol = document.getElementById('rankSymbol');
        }

        // Level titles and symbols based on Solo Leveling
        const levelTitles = {
            1: { title: "E-Rank Hunter", symbol: "‚öîÔ∏è" },
            10: { title: "D-Rank Hunter", symbol: "üó°Ô∏è" },
            20: { title: "C-Rank Hunter", symbol: "‚ö°" },
            30: { title: "B-Rank Hunter", symbol: "üíé" },
            40: { title: "A-Rank Hunter", symbol: "üî•" },
            50: { title: "S-Rank Hunter", symbol: "üëë" },
            70: { title: "National Level Hunter", symbol: "üåü" },
            90: { title: "Monarch Candidate", symbol: "ü¶Ö" },
            100: { title: "Shadow Monarch", symbol: "üåë" }
        };

        function getLevelTitle(level) {
            let currentTitle = levelTitles[1];
            for (let lvl in levelTitles) {
                if (level >= parseInt(lvl)) {
                    currentTitle = levelTitles[lvl];
                }
            }
            return currentTitle;
        }

        // Check for midnight reset
        function checkMidnightReset() {
            const now = new Date();
            const today = now.toDateString();
            
            if (gameState.lastResetDate !== today) {
                // CRITICAL: Backup templates before any operations
                const savedTemplates = gameState.savedQuests ? [...gameState.savedQuests] : [];
                
                // IMPORTANT: Check for expired quests BEFORE deleting them
                // This applies penalties for incomplete daily quests
                checkQuestExpiration();
                
                // NOW remove all daily quests (already penalized if expired)
                gameState.quests = gameState.quests.filter(q => q.type !== 'daily');
                
                // Reset daily tracking stats
                gameState.todayCompleted = 0;
                gameState.todayXP = 0;
                gameState.todayGold = 0;
                
                // Reset fatigue (but not penalty if active)
                if (!gameState.penaltyUntil || Date.now() > gameState.penaltyUntil) {
                    gameState.fatigue = 0;
                }
                
                // Update last reset date
                gameState.lastResetDate = today;
                
                // CRITICAL: Restore templates after reset operations
                gameState.savedQuests = savedTemplates;
                
                saveGame();
                updateUI();
                
                // Show notification
                showNotification('üåÖ Daily Reset: Fatigue cleared & Daily missions reset!', 'info');
                
                // Log the reset
                gameState.logs.push({
                    timestamp: Date.now(),
                    text: `Daily reset completed - All daily missions cleared and fatigue reset to 0%`
                });
                saveGame();
            }
        }

        // Load saved state
        function loadGame() {
            const saved = localStorage.getItem('sovereignZenith');
            if (saved) {
                const parsed = JSON.parse(saved);
                
                // CRITICAL: Preserve savedQuests if it exists in saved data
                const preservedTemplates = parsed.savedQuests || gameState.savedQuests || [];
                
                gameState = { ...gameState, ...parsed };
                
                // CRITICAL: Explicitly restore savedQuests to prevent data loss
                gameState.savedQuests = preservedTemplates;
                
                // Clear penalty if time has passed
                if (gameState.penaltyUntil && Date.now() > gameState.penaltyUntil) {
                    gameState.penaltyUntil = null;
                    gameState.fatigue = 0;
                }
                
                // Ensure HP doesn't exceed max
                if (gameState.hp > gameState.maxHP) {
                    gameState.hp = gameState.maxHP;
                }
            }
            
            // Ensure savedQuests exists (for backwards compatibility)
            if (!gameState.savedQuests) {
                gameState.savedQuests = [];
            }
            
            // Check for midnight reset on load
            checkMidnightReset();
            
            // Check daily login
            checkDailyLogin();
            
            // Initialize settings
            initializeSettings();
            
            updateUI();
        }

        // System Voice Notifications
        function speakSystem(text) {
            if (!gameState.voiceEnabled || !('speechSynthesis' in window)) return;
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.9;
            utterance.pitch = 0.8;
            utterance.volume = 0.7;
            speechSynthesis.speak(utterance);
        }

        // Daily Login Rewards System
        const loginRewards = [
            { day: 1, gold: 100, shards: 0, keys: 0, desc: '100 Gold' },
            { day: 2, gold: 150, shards: 5, keys: 0, desc: '150 Gold + 5 Shards' },
            { day: 3, gold: 200, shards: 0, keys: 0, desc: '200 Gold' },
            { day: 4, gold: 250, shards: 10, keys: 0, desc: '250 Gold + 10 Shards' },
            { day: 5, gold: 300, shards: 0, keys: 0, desc: '300 Gold' },
            { day: 6, gold: 400, shards: 15, keys: 0, desc: '400 Gold + 15 Shards' },
            { day: 7, gold: 500, shards: 20, keys: 1, desc: '500 Gold + 20 Shards + Key!' },
            { day: 14, gold: 1000, shards: 50, keys: 2, desc: '1000 Gold + 50 Shards + 2 Keys!' },
            { day: 30, gold: 3000, shards: 100, keys: 5, desc: '3000 Gold + 100 Shards + 5 Keys!' }
        ];

        function checkDailyLogin() {
            const today = new Date().toDateString();
            
            if (gameState.lastLoginDate !== today) {
                // Calculate streak
                if (gameState.lastLoginDate) {
                    const lastLogin = new Date(gameState.lastLoginDate);
                    const todayDate = new Date(today);
                    const daysDiff = Math.floor((todayDate - lastLogin) / (1000 * 60 * 60 * 24));
                    
                    if (daysDiff === 1) {
                        gameState.loginStreak++;
                    } else if (daysDiff > 1) {
                        gameState.loginStreak = 1;
                    }
                } else {
                    gameState.loginStreak = 1;
                }
                
                // Track longest streak
                updateStatistics();
                if (gameState.loginStreak > gameState.stats.longestLoginStreak) {
                    gameState.stats.longestLoginStreak = gameState.loginStreak;
                }
                
                gameState.lastLoginDate = today;
                saveGame();
                
                // Show login reward notification
                showNotification(`üéÅ Day ${gameState.loginStreak} Login! Check Rewards tab`, 'legendary');
                speakSystem(`Welcome back, Hunter. Day ${gameState.loginStreak} login detected.`);
            }
        }

        function renderLoginRewards() {
            const list = document.getElementById('loginRewardsList');
            if (!list) return;
            
            document.getElementById('loginStreak').textContent = gameState.loginStreak;
            
            list.innerHTML = loginRewards.map(reward => {
                const canClaim = gameState.loginStreak >= reward.day && !gameState.loginRewardsClaimed.includes(reward.day);
                const claimed = gameState.loginRewardsClaimed.includes(reward.day);
                
                return `
                    <div class="glass rounded p-3 ${canClaim ? 'neon-border pulse-anim' : ''} ${claimed ? 'opacity-50' : ''}">
                        <div class="text-center mb-2">
                            <div class="text-cyan-400 font-bold">Day ${reward.day}</div>
                            <div class="text-xs text-gray-400 mt-1">${reward.desc}</div>
                        </div>
                        ${claimed ? 
                            '<div class="text-xs text-green-400 text-center">‚úì Claimed</div>' : 
                            canClaim ?
                            `<button onclick="claimLoginReward(${reward.day})" class="w-full bg-green-600 hover:bg-green-500 text-white px-2 py-1 rounded text-xs">Claim</button>` :
                            '<div class="text-xs text-gray-500 text-center">Locked</div>'
                        }
                    </div>
                `;
            }).join('');
        }

        function claimLoginReward(day) {
            const reward = loginRewards.find(r => r.day === day);
            if (!reward || gameState.loginRewardsClaimed.includes(day)) return;
            
            gameState.gold += reward.gold;
            gameState.shards += reward.shards;
            gameState.keys += reward.keys;
            gameState.loginRewardsClaimed.push(day);
            
            saveGame();
            updateUI();
            showNotification(`Claimed Day ${day} Reward!`, 'legendary');
            speakSystem(`Day ${day} reward claimed.`);
        }

        // Combo System
        function updateCombo() {
            const now = Date.now();
            const timeSinceLastQuest = gameState.lastQuestCompleteTime ? now - gameState.lastQuestCompleteTime : 999999;
            
            // Combo breaks after 5 minutes of inactivity
            if (timeSinceLastQuest > 5 * 60 * 1000) {
                if (gameState.comboCount > 0) {
                    showNotification('Combo broken!', 'error');
                    gameState.comboCount = 0;
                }
            }
            
            // Update combo display
            const comboDisplay = document.getElementById('comboDisplay');
            const comboCountElem = document.getElementById('comboCount');
            const comboBonusElem = document.getElementById('comboBonus');
            
            if (gameState.comboCount >= 3) {
                comboDisplay.classList.remove('hidden');
                comboCountElem.textContent = gameState.comboCount;
                
                let bonus = 0;
                if (gameState.comboCount >= 10) bonus = 50;
                else if (gameState.comboCount >= 5) bonus = 25;
                else if (gameState.comboCount >= 3) bonus = 10;
                
                comboBonusElem.textContent = bonus;
            } else {
                comboDisplay.classList.add('hidden');
            }
        }

        function getComboMultiplier() {
            if (gameState.comboCount >= 10) return 1.5;
            if (gameState.comboCount >= 5) return 1.25;
            if (gameState.comboCount >= 3) return 1.1;
            return 1.0;
        }

        // Job Class System
        const jobClasses = {
            necromancer: {
                name: 'Necromancer',
                desc: 'Master of shadows. +50% shadow power, +5 shadow slots',
                icon: 'üíÄ',
                bonuses: { shadowPower: 1.5, shadowSlots: 5 }
            },
            berserker: {
                name: 'Berserker',
                desc: 'Raw physical power. +100% STR gain, +50% damage',
                icon: '‚öîÔ∏è',
                bonuses: { strMultiplier: 2, damageMultiplier: 1.5 }
            },
            assassin: {
                name: 'Assassin',
                desc: 'Swift and deadly. +100% AGI gain, reduced fatigue',
                icon: 'üó°Ô∏è',
                bonuses: { agiMultiplier: 2, fatigueReduction: 0.75 }
            },
            sage: {
                name: 'Sage',
                desc: 'Wisdom incarnate. +100% INT gain, +50% XP',
                icon: 'üìö',
                bonuses: { intMultiplier: 2, xpBonus: 1.5 }
            }
        };

        function renderJobClass() {
            const status = document.getElementById('jobClassStatus');
            const options = document.getElementById('jobClassOptions');
            
            if (gameState.level < 40) {
                status.textContent = `Unlock at Level 40 (Currently: ${gameState.level})`;
                options.classList.add('hidden');
                return;
            }
            
            if (gameState.jobClass) {
                const job = jobClasses[gameState.jobClass];
                status.innerHTML = `<div class="glass rounded p-4 neon-border">
                    <div class="text-center">
                        <div class="text-4xl mb-2">${job.icon}</div>
                        <div class="text-cyan-400 font-bold text-xl">${job.name}</div>
                        <div class="text-sm text-gray-300 mt-2">${job.desc}</div>
                    </div>
                </div>`;
                options.classList.add('hidden');
                return;
            }
            
            status.textContent = 'Choose Your Job Class';
            options.classList.remove('hidden');
            options.innerHTML = Object.keys(jobClasses).map(key => {
                const job = jobClasses[key];
                return `
                    <div class="glass rounded p-4 hover:neon-border cursor-pointer" onclick="selectJobClass('${key}')">
                        <div class="flex items-center gap-3">
                            <div class="text-3xl">${job.icon}</div>
                            <div class="flex-1">
                                <div class="text-cyan-400 font-bold">${job.name}</div>
                                <div class="text-xs text-gray-300">${job.desc}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function selectJobClass(classKey) {
            if (gameState.level < 40 || gameState.jobClass) return;
            
            gameState.jobClass = classKey;
            gameState.jobClassUnlockedAt = Date.now();
            
            const job = jobClasses[classKey];
            saveGame();
            updateUI();
            
            showNotification(`Job Class Unlocked: ${job.name}!`, 'legendary');
            speakSystem(`Job class acquired: ${job.name}. Your powers have evolved.`);
        }

        // Shadow Rank System
        const shadowRanks = ['Normal', 'Elite', 'Knight', 'General', 'Marshal'];

        function getShadowRank(power) {
            if (power >= 1000) return 'Marshal';
            if (power >= 500) return 'General';
            if (power >= 250) return 'Knight';
            if (power >= 100) return 'Elite';
            return 'Normal';
        }

        function getShadowStars(rank) {
            const stars = {
                'Normal': '‚≠ê',
                'Elite': '‚≠ê‚≠ê',
                'Knight': '‚≠ê‚≠ê‚≠ê',
                'General': '‚≠ê‚≠ê‚≠ê‚≠ê',
                'Marshal': '‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê'
            };
            return stars[rank] || '‚≠ê';
        }

        // Update shadow rendering to include ranks
        function updateShadowWithRank(shadow) {
            shadow.rank = getShadowRank(shadow.power);
            shadow.stars = getShadowStars(shadow.rank);
            return shadow;
        }

        // Statistics System
        function updateStatistics() {
            if (!gameState.stats) {
                gameState.stats = {
                    totalQuestsCompleted: 0,
                    totalQuestsFailed: 0,
                    totalXPEarned: 0,
                    totalGoldEarned: 0,
                    longestLoginStreak: 0,
                    highestCombo: 0,
                    shadowsExtracted: 0,
                    bossesDefeated: 0,
                    emergencyQuestsCompleted: 0,
                    strQuests: 0,
                    intQuests: 0,
                    agiQuests: 0,
                    senQuests: 0
                };
            }
        }

        function renderStatistics() {
            updateStatistics();
            
            const stats = gameState.stats;
            const totalQuests = stats.totalQuestsCompleted + stats.totalQuestsFailed;
            const successRate = totalQuests > 0 ? Math.round((stats.totalQuestsCompleted / totalQuests) * 100) : 100;
            
            // Update main stats
            document.getElementById('totalQuests').textContent = stats.totalQuestsCompleted;
            document.getElementById('totalXP').textContent = Math.floor(stats.totalXPEarned);
            document.getElementById('totalGold').textContent = Math.floor(stats.totalGoldEarned);
            document.getElementById('successRate').textContent = successRate + '%';
            
            // Update records
            document.getElementById('longestStreak').textContent = stats.longestLoginStreak + ' days';
            document.getElementById('highestCombo').textContent = stats.highestCombo + 'x';
            document.getElementById('shadowsExtracted').textContent = stats.shadowsExtracted;
            document.getElementById('bossesDefeated').textContent = stats.bossesDefeated;
            document.getElementById('emergencyCompleted').textContent = stats.emergencyQuestsCompleted;
            
            // Update stat distribution
            const totalStatQuests = stats.strQuests + stats.intQuests + stats.agiQuests + stats.senQuests;
            
            if (totalStatQuests > 0) {
                const strPercent = (stats.strQuests / totalStatQuests) * 100;
                const intPercent = (stats.intQuests / totalStatQuests) * 100;
                const agiPercent = (stats.agiQuests / totalStatQuests) * 100;
                const senPercent = (stats.senQuests / totalStatQuests) * 100;
                
                document.getElementById('strQuestCount').textContent = stats.strQuests;
                document.getElementById('intQuestCount').textContent = stats.intQuests;
                document.getElementById('agiQuestCount').textContent = stats.agiQuests;
                document.getElementById('senQuestCount').textContent = stats.senQuests;
                
                document.getElementById('strQuestBar').style.width = strPercent + '%';
                document.getElementById('intQuestBar').style.width = intPercent + '%';
                document.getElementById('agiQuestBar').style.width = agiPercent + '%';
                document.getElementById('senQuestBar').style.width = senPercent + '%';
            }
        }

        function trackQuestComplete(quest, xpGained, goldGained) {
            updateStatistics();
            gameState.stats.totalQuestsCompleted++;
            gameState.stats.totalXPEarned += xpGained;
            gameState.stats.totalGoldEarned += goldGained;
            
            // Track stat type
            if (quest.statType && quest.statType !== 'none') {
                gameState.stats[quest.statType + 'Quests']++;
            }
            
            // Track combo
            if (gameState.comboCount > gameState.stats.highestCombo) {
                gameState.stats.highestCombo = gameState.comboCount;
            }
            
            // Track emergency
            if (quest.name && quest.name.includes('[EMERGENCY]')) {
                gameState.stats.emergencyQuestsCompleted++;
            }
        }

        function trackQuestFailed() {
            updateStatistics();
            gameState.stats.totalQuestsFailed++;
        }

        function trackShadowExtracted() {
            updateStatistics();
            gameState.stats.shadowsExtracted++;
        }

        function trackBossDefeated() {
            updateStatistics();
            gameState.stats.bossesDefeated++;
        }

        // Potion System
        function buyPotion(type, cost) {
            if (gameState.gold < cost) {
                showNotification('Not enough gold', 'error');
                return;
            }
            
            gameState.gold -= cost;
            gameState.potions[type]++;
            
            saveGame();
            updateUI();
            updatePotionCounts();
            showNotification(`Purchased ${getPotionName(type)}`, 'success');
        }

        function usePotion(type) {
            if (!gameState.potions[type] || gameState.potions[type] <= 0) {
                showNotification(`No ${getPotionName(type)} available`, 'error');
                return;
            }
            
            gameState.potions[type]--;
            
            switch(type) {
                case 'healthPotion':
                    gameState.hp = Math.min(gameState.maxHP, gameState.hp + 30);
                    gameState.fatigue = Math.min(100, gameState.fatigue + 5);
                    showNotification('HP +30, Fatigue +5%', 'success');
                    break;
                    
                case 'fatiguePotion':
                    gameState.fatigue = Math.max(0, gameState.fatigue - 25);
                    gameState.hp = Math.max(0, gameState.hp - 10);
                    showNotification('Fatigue -25%, HP -10', 'success');
                    break;
                    
                case 'xpPotion':
                    gameState.xp += 50;
                    gameState.fatigue = Math.min(100, gameState.fatigue + 10);
                    showNotification('XP +50, Fatigue +10%', 'success');
                    checkLevelUp();
                    break;
                    
                case 'cursedPotion':
                    gameState.xp += 100;
                    gameState.gold += 50;
                    gameState.hp = Math.max(0, gameState.hp - 20);
                    gameState.fatigue = Math.min(100, gameState.fatigue + 15);
                    showNotification('Cursed! XP +100, Gold +50, HP -20, Fatigue +15%', 'legendary');
                    checkLevelUp();
                    break;
            }
            
            saveGame();
            updateUI();
            updatePotionCounts();
        }

        function getPotionName(type) {
            const names = {
                'healthPotion': 'Health Potion',
                'fatiguePotion': 'Stamina Potion',
                'xpPotion': 'XP Elixir',
                'cursedPotion': 'Cursed Potion'
            };
            return names[type] || 'Potion';
        }

        function updatePotionCounts() {
            ['healthPotion', 'fatiguePotion', 'xpPotion', 'cursedPotion'].forEach(type => {
                const elem = document.getElementById(type + 'Count');
                if (elem) {
                    elem.textContent = gameState.potions[type] || 0;
                }
            });
        }

        function checkLevelUp() {
            const maxXP = gameState.level * 500;
            while (gameState.xp >= maxXP) {
                addXP(0); // Trigger level up without adding more XP
            }
        }

        // Saved Quest Templates System
        function saveCurrentQuest() {
            if (gameState.quests.length === 0) {
                showNotification('No quests to save as template', 'error');
                return;
            }
            
            // Get the most recently added quest
            const lastQuest = gameState.quests[gameState.quests.length - 1];
            
            // Check if already saved
            const exists = gameState.savedQuests.some(q => 
                q.name === lastQuest.name && q.rank === lastQuest.rank && q.statType === lastQuest.statType
            );
            
            if (exists) {
                showNotification('This quest template already exists', 'error');
                return;
            }
            
            gameState.savedQuests.push({
                name: lastQuest.name,
                rank: lastQuest.rank,
                statType: lastQuest.statType || 'none'
            });
            
            saveGame();
            renderSavedQuests();
            showNotification('Quest saved as template!', 'success');
        }

        function addSavedQuest(index) {
            const template = gameState.savedQuests[index];
            if (!template) return;
            
            const multiplier = rankMultipliers[template.rank];
            const typeMultiplier = gameState.questMode === 'longterm' ? 10 : 1;
            const statBonus = multiplier * 2;
            
            const expiresAt = gameState.questMode === 'daily' 
                ? new Date().setHours(23, 59, 59, 999)
                : Date.now() + (7 * 24 * 60 * 60 * 1000);
            
            const quest = {
                name: template.name,
                rank: template.rank,
                type: gameState.questMode,
                xp: 30 * multiplier * typeMultiplier,
                gold: 15 * multiplier * typeMultiplier,
                fatigue: 3 * multiplier,
                statType: template.statType,
                statBonus: statBonus,
                timestamp: Date.now(),
                expiresAt: expiresAt,
                accepted: true
            };
            
            gameState.quests.push(quest);
            saveGame();
            updateUI();
            showNotification(`Added: ${template.name}`, 'success');
        }

        function deleteSavedQuest(index) {
            if (confirm('Delete this quest template?')) {
                gameState.savedQuests.splice(index, 1);
                saveGame();
                renderSavedQuests();
                showNotification('Template deleted', 'info');
            }
        }

        function renderSavedQuests() {
            const list = document.getElementById('savedQuestsList');
            if (!list) return;
            
            if (gameState.savedQuests.length === 0) {
                list.innerHTML = '<p class="text-gray-400 text-center text-xs py-2">No saved templates</p>';
                return;
            }
            
            list.innerHTML = gameState.savedQuests.map((template, idx) => `
                <div class="glass rounded p-2 flex justify-between items-center">
                    <div class="flex-1">
                        <span class="rank-${template.rank.toLowerCase()} font-bold text-xs">[${template.rank}]</span>
                        <span class="text-white text-sm ml-1">${template.name}</span>
                        ${template.statType && template.statType !== 'none' ? 
                            `<span class="text-xs text-gray-400 ml-1">(${template.statType.toUpperCase()})</span>` : ''}
                    </div>
                    <div class="flex gap-1">
                        <button onclick="addSavedQuest(${idx})" class="px-2 py-1 bg-green-600 hover:bg-green-700 text-white rounded text-xs">
                            +
                        </button>
                        <button onclick="deleteSavedQuest(${idx})" class="px-2 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-xs">
                            ‚úó
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Help System
        function showHelp(topic) {
            const helpTexts = {
                'store': 'The Reliquary: Buy Soul Shards for crafting and Potions for buffs. Potions have side effects!',
                'templates': 'Save frequently used quests as templates. Click + to add them instantly, ‚úó to delete.',
                'chains': 'Quest Chains: Complete the same quest for 7 days straight to level up! Max level gives permanent stat buffs. Example: 10 Pushups ‚Üí 20 Pushups ‚Üí 30 Pushups ‚Üí ... ‚Üí 50 Pushups (Master) = Permanent +10 STR!',
                'stealth': 'Stealth Mode: -50% quest fatigue, but -25% XP earned! Strategy: Use for grinding many low-value quests without exhaustion. Cost: +15% fatigue to activate, need <85% fatigue. Trade power for efficiency.',
                'bloodlust': 'Bloodlust Mode: +75% XP & Gold, but 2x fatigue cost & -20 HP! Strategy: Use on high-value quests for massive rewards. Cost: +20% fatigue, -20 HP, need <70% fatigue & 30+ HP. High risk, high reward!',
                'domain': 'Domain Expansion: Next quest gets 3x XP, 3x Gold, 0 fatigue! One-time ultimate power. Cost: -30 HP, -100 Gold, +30% fatigue. Requires <60% fatigue & 50+ HP. Save for S-Rank quests!',
                'evolution': 'Spend shards to permanently upgrade your stats. Each level costs more shards.',
                'garden': 'Shadows passively generate gold while the app is open. Must activate first for 50 shards.',
                'skills': 'Unlock powerful abilities with cooldowns. Mutilate damages bosses, Dragon\'s Breath reduces fatigue.',
                'redgate': 'Send shadows on idle missions. They earn rewards over time even when app is closed.',
                'forge': 'Craft shadow gear from shards and fuse shadows to make them stronger.',
                'bosses': 'World bosses appear every 10 levels. Defeat them to extract shadows!',
                'glitch': 'Corrupted dungeons that appear rarely. Require Architect Keys from S-Rank quests.',
                'achievements': 'Hidden goals that give permanent bonuses when unlocked.',
                'rewards': 'Daily login rewards increase your streak. Choose a job class at level 40.',
                'stats': 'View your lifetime statistics and quest distribution.',
                'settings': 'Customize voice, animations, and backup your save data.'
            };
            
            const text = helpTexts[topic] || 'Information not available.';
            alert('‚ÑπÔ∏è ' + text);
        }

        // Fix mode toggles to actually apply fatigue
        function activateStealth() {
            if (gameState.fatigue >= 85) {
                showNotification('Too fatigued to activate Stealth Mode (need <85% fatigue)', 'error');
                return;
            }
            
            gameState.stealthMode = !gameState.stealthMode;
            if (gameState.stealthMode) {
                document.body.style.filter = 'grayscale(100%) contrast(0.8)';
                gameState.fatigue += 15;
                
                // COST: Reduce XP gain by 25% while active
                showNotification('üåë Stealth Mode ON: -50% quest fatigue, but -25% XP! (+15% fatigue)', 'success');
                speakSystem('Stealth mode activated. Moving silently. Reduced experience gain.');
            } else {
                document.body.style.filter = '';
                showNotification('üåë Stealth Mode OFF: Normal XP and fatigue restored', 'info');
            }
            saveGame();
            updateUI();
        }

        function activateBloodlust() {
            if (gameState.fatigue >= 70) {
                showNotification('Too fatigued to activate Bloodlust (need <70% fatigue)', 'error');
                return;
            }
            
            if (gameState.hp < 30) {
                showNotification('HP too low for Bloodlust! Need at least 30 HP', 'error');
                return;
            }
            
            gameState.bloodlustMode = !gameState.bloodlustMode;
            if (gameState.bloodlustMode) {
                document.body.style.filter = 'saturate(2) hue-rotate(-10deg) contrast(1.2)';
                gameState.fatigue += 20;
                gameState.hp -= 20; // COST: Lose HP immediately
                
                // COST: Fatigue from quests DOUBLED while active
                showNotification('üíÄ BLOODLUST ON: +75% XP & Gold, but 2x fatigue cost & -20 HP! (+20% fatigue)', 'legendary');
                speakSystem('Bloodlust activated. Power surges. Health sacrificed.');
            } else {
                document.body.style.filter = '';
                showNotification('üíÄ Bloodlust OFF: Normal rewards and fatigue costs', 'info');
            }
            saveGame();
            updateUI();
        }

        function activateDomain() {
            if (gameState.fatigue >= 60) {
                showNotification('Too fatigued for Domain Expansion (need <60% fatigue)', 'error');
                return;
            }
            
            if (gameState.hp < 50) {
                showNotification('HP too low for Domain Expansion! Need at least 50 HP', 'error');
                return;
            }
            
            if (gameState.gold < 100) {
                showNotification('Need 100 Gold to activate Domain Expansion!', 'error');
                return;
            }
            
            // HEAVY COSTS
            playSound('domain');
            gameState.fatigue += 30;
            gameState.hp -= 30;
            gameState.gold -= 100;
            
            // POWERFUL BENEFIT: Next quest gives 3x XP, 3x Gold, 0 fatigue!
            if (!gameState.domainActive) {
                gameState.domainActive = true;
                showNotification('‚ö° DOMAIN EXPANSION! Next quest: 3x XP, 3x Gold, 0 fatigue! (-30 HP, -100 Gold, +30% fatigue)', 'legendary');
                speakSystem('Domain Expansion. Reality warped. Maximum power achieved.');
            }
            
            const app = document.getElementById('app');
            app.classList.add('domain-expansion');
            setTimeout(() => app.classList.remove('domain-expansion'), 800);
            
            saveGame();
            updateUI();
        }

        // Export/Import System
        function exportSaveData() {
            const saveData = {
                version: '43.0',
                timestamp: Date.now(),
                data: gameState
            };
            
            const jsonString = JSON.stringify(saveData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sovereign-zenith-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('Save data exported!', 'success');
            speakSystem('Save data exported successfully.');
        }

        function importSaveData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    
                    if (!imported.data) {
                        throw new Error('Invalid save file');
                    }
                    
                    if (confirm('Import this save? Current progress will be overwritten!')) {
                        gameState = { ...gameState, ...imported.data };
                        localStorage.setItem('sovereignZenith', JSON.stringify(gameState));
                        
                        showNotification('Save data imported!', 'success');
                        speakSystem('Save data imported successfully.');
                        updateUI();
                        
                        // Reload page to ensure everything initializes correctly
                        setTimeout(() => location.reload(), 1000);
                    }
                } catch (error) {
                    showNotification('Import failed: Invalid file', 'error');
                    console.error('Import error:', error);
                }
            };
            reader.readAsText(file);
        }

        function clearAllData() {
            if (!confirm('Delete ALL progress? This cannot be undone!')) return;
            if (!confirm('Are you ABSOLUTELY sure? All data will be lost forever!')) return;
            
            localStorage.removeItem('sovereignZenith');
            showNotification('All data cleared. Reloading...', 'info');
            setTimeout(() => location.reload(), 1000);
        }

        function testVoice() {
            speakSystem('System voice test. All systems operational. Welcome, Hunter.');
        }

        // Settings handlers
        function initializeSettings() {
            const voiceToggle = document.getElementById('voiceToggle');
            const animationsToggle = document.getElementById('animationsToggle');
            
            if (voiceToggle) {
                voiceToggle.checked = gameState.voiceEnabled;
                voiceToggle.addEventListener('change', (e) => {
                    gameState.voiceEnabled = e.target.checked;
                    saveGame();
                    if (gameState.voiceEnabled) {
                        speakSystem('Voice notifications enabled.');
                    }
                });
            }
            
            if (animationsToggle) {
                const animsEnabled = localStorage.getItem('animationsEnabled') !== 'false';
                animationsToggle.checked = animsEnabled;
                animationsToggle.addEventListener('change', (e) => {
                    localStorage.setItem('animationsEnabled', e.target.checked);
                    if (!e.target.checked) {
                        document.body.classList.add('reduce-animations');
                    } else {
                        document.body.classList.remove('reduce-animations');
                    }
                    showNotification('Animation setting updated', 'info');
                });
            }
        }

        // Save game state (debounced for performance)
        let saveTimeout;
        function saveGame() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                localStorage.setItem('sovereignZenith', JSON.stringify(gameState));
            }, 500); // Save max once every 500ms
        }
        
        // Immediate save for critical operations
        function saveGameImmediate() {
            clearTimeout(saveTimeout);
            localStorage.setItem('sovereignZenith', JSON.stringify(gameState));
        }

        // Update UI with requestAnimationFrame for smooth performance
        let updateScheduled = false;
        function updateUI() {
            if (updateScheduled) return;
            updateScheduled = true;
            
            requestAnimationFrame(() => {
                updateScheduled = false;
                
                // Update core stats using cached elements (faster!)
                if (domCache.level) domCache.level.textContent = gameState.level;
                if (domCache.gold) domCache.gold.textContent = Math.floor(gameState.gold);
                if (domCache.shards) domCache.shards.textContent = gameState.shards;
                if (domCache.keys) domCache.keys.textContent = gameState.keys;
                if (domCache.str) domCache.str.textContent = gameState.str;
                if (domCache.int) domCache.int.textContent = gameState.int;
                if (domCache.agi) domCache.agi.textContent = gameState.agi;
                if (domCache.sen) domCache.sen.textContent = gameState.sen;
                
                // Update HP
                if (domCache.currentHP) domCache.currentHP.textContent = Math.floor(gameState.hp);
                if (domCache.maxHP) domCache.maxHP.textContent = gameState.maxHP;
                if (domCache.hpBar) domCache.hpBar.style.width = (gameState.hp / gameState.maxHP * 100) + '%';
                
                // Update level title and symbol
                const titleInfo = getLevelTitle(gameState.level);
                if (domCache.levelTitle) domCache.levelTitle.textContent = titleInfo.title;
                if (domCache.levelSymbol) domCache.levelSymbol.textContent = titleInfo.symbol;
                if (domCache.rankSymbol) domCache.rankSymbol.textContent = titleInfo.symbol;
                
                const maxXP = gameState.level * 500;
                if (domCache.currentXP) domCache.currentXP.textContent = Math.floor(gameState.xp);
                if (domCache.maxXP) domCache.maxXP.textContent = maxXP;
                if (domCache.xpBar) domCache.xpBar.style.width = (gameState.xp / maxXP * 100) + '%';
                
                if (domCache.fatiguePercent) domCache.fatiguePercent.textContent = Math.round(gameState.fatigue) + '%';
                if (domCache.fatigueBar) domCache.fatigueBar.style.width = gameState.fatigue + '%';
                
                updateCombo();
                checkPenalty();
                
                // FORCE: Always render quests regardless of tab (temporary fix)
                try {
                    renderQuests();
                } catch (e) {
                    console.error('renderQuests error:', e);
                }
                
                // Only render active tab content (MAJOR PERFORMANCE BOOST)
                renderActiveTab();
            });
        }
        
        // Render only the currently visible tab
        function renderActiveTab() {
            const activeTab = document.querySelector('.content-panel:not(.hidden)');
            if (!activeTab) return;
            
            const tabId = activeTab.id;
            
            switch(tabId) {
                case 'quests':
                    renderQuests();
                    renderEmergencyQuest();
                    renderSavedQuests();
                    break;
                case 'rewards':
                    renderLoginRewards();
                    renderJobClass();
                    break;
                case 'shadows':
                    renderShadows();
                    break;
                case 'store':
                    updatePotionCounts();
                    break;
                case 'forge':
                    renderGear();
                    break;
                case 'evolution':
                    updateEvolutionUI();
                    break;
                case 'garden':
                    updateGarden();
                    break;
                case 'skills':
                    renderSkills();
                    break;
                case 'redgate':
                    updateRaidDropdown();
                    renderRaids();
                    break;
                case 'bosses':
                    updateBoss();
                    break;
                case 'glitch':
                    updateGlitchGates();
                    break;
                case 'achievements':
                    renderAchievements();
                    checkAchievements();
                    break;
                case 'stats':
                    renderStatistics();
                    break;
                case 'chronicle':
                    renderLogs();
                    break;
            }
            
            // Check raids on any tab change
            checkRaids();
            
            // Update mode button states
            const stealthBtn = document.getElementById('stealthBtn');
            const bloodlustBtn = document.getElementById('bloodlustBtn');
            const domainBtn = document.getElementById('domainBtn');
            
            if (stealthBtn) {
                if (gameState.stealthMode) {
                    stealthBtn.classList.add('ring-2', 'ring-green-400');
                    stealthBtn.textContent = 'üåë Stealth (ON)';
                } else {
                    stealthBtn.classList.remove('ring-2', 'ring-green-400');
                    stealthBtn.textContent = 'üåë Stealth';
                }
            }
            
            if (bloodlustBtn) {
                if (gameState.bloodlustMode) {
                    bloodlustBtn.classList.add('ring-2', 'ring-red-400');
                    bloodlustBtn.textContent = 'üíÄ Bloodlust (ON)';
                } else {
                    bloodlustBtn.classList.remove('ring-2', 'ring-red-400');
                    bloodlustBtn.textContent = 'üíÄ Bloodlust';
                }
            }
            
            if (domainBtn) {
                if (gameState.domainActive) {
                    domainBtn.classList.add('ring-2', 'ring-yellow-400');
                    domainBtn.textContent = '‚ö° Domain (READY!)';
                } else {
                    domainBtn.classList.remove('ring-2', 'ring-yellow-400');
                    domainBtn.textContent = '‚ö° Domain';
                }
            }
        }

        // Check for penalty zone
        function checkPenalty() {
            if (gameState.penaltyUntil && Date.now() < gameState.penaltyUntil) {
                showPenaltyScreen();
            }
        }

        function showPenaltyScreen() {
            const remaining = Math.ceil((gameState.penaltyUntil - Date.now()) / 1000 / 60);
            if (remaining <= 0) {
                gameState.penaltyUntil = null;
                gameState.fatigue = 0;
                saveGame();
                updateUI();
                return;
            }
            
            let penaltyDiv = document.getElementById('penaltyScreen');
            if (!penaltyDiv) {
                penaltyDiv = document.createElement('div');
                penaltyDiv.id = 'penaltyScreen';
                penaltyDiv.className = 'penalty-screen';
                document.body.appendChild(penaltyDiv);
            }
            
            penaltyDiv.innerHTML = `
                <div class="glass rounded-lg p-8 text-center max-w-md">
                    <h2 class="text-4xl font-black text-red-400 neon-glow mb-4">PENALTY ZONE</h2>
                    <p class="text-white text-xl mb-4">Fatigue Overload</p>
                    <p class="text-purple-300 mb-4">Your monarch must rest.</p>
                    <p class="text-cyan-400 text-3xl font-bold">${remaining} minutes</p>
                    <p class="text-gray-400 text-sm mt-4">Lockout expires when timer reaches 0</p>
                </div>
            `;
            
            setTimeout(() => {
                if (gameState.penaltyUntil && Date.now() < gameState.penaltyUntil) {
                    showPenaltyScreen();
                } else {
                    const screen = document.getElementById('penaltyScreen');
                    if (screen) screen.remove();
                    updateUI();
                }
            }, 60000);
        }

        // XP and Leveling
        function addXP(amount) {
            gameState.xp += amount * gameState.xpMultiplier * (gameState.jobClass === 'sage' ? 1.5 : 1);
            const maxXP = gameState.level * 500;
            
            if (gameState.xp >= maxXP) {
                gameState.xp -= maxXP;
                gameState.level++;
                gameState.str += 2;
                gameState.int += 2;
                gameState.agi += 2;
                gameState.sen += 2;
                gameState.maxHP += 10;
                gameState.hp = gameState.maxHP; // Full heal on level up
                
                playSound('levelup');
                speakSystem(`Level up achieved. You are now level ${gameState.level}.`);
                
                // Heavy level up animation
                const app = document.getElementById('app');
                app.classList.add('levelup-burst');
                setTimeout(() => app.classList.remove('levelup-burst'), 1000);
                
                showNotification(`LEVEL UP! You are now Level ${gameState.level}`, 'success');
                
                // Check for world boss
                if (gameState.level % 10 === 0) {
                    spawnWorldBoss();
                }
                
                // Check if job class unlocked
                if (gameState.level === 40 && !gameState.jobClass) {
                    showNotification('üéâ Job Class System Unlocked! Check Rewards tab', 'legendary');
                    speakSystem('Job class system unlocked. Your potential expands.');
                }
            }
            
            saveGame();
            updateUI();
        }

        // Action History for Undo
        function saveAction(actionType, data) {
            gameState.actionHistory.push({
                type: actionType,
                data: JSON.parse(JSON.stringify(data)),
                timestamp: Date.now()
            });
            
            // Keep only last 10 actions
            if (gameState.actionHistory.length > 10) {
                gameState.actionHistory.shift();
            }
        }

        function undoLastAction() {
            if (gameState.actionHistory.length === 0) {
                showNotification('No actions to undo', 'error');
                return;
            }
            
            const action = gameState.actionHistory.pop();
            
            switch (action.type) {
                case 'completeQuest':
                    gameState.xp = action.data.xp;
                    gameState.gold = action.data.gold;
                    gameState.fatigue = action.data.fatigue;
                    gameState.str = action.data.str;
                    gameState.int = action.data.int;
                    gameState.agi = action.data.agi;
                    gameState.sen = action.data.sen;
                    gameState.level = action.data.level;
                    gameState.quests.push(action.data.quest);
                    break;
                case 'addQuest':
                    const questIdx = gameState.quests.findIndex(q => 
                        q.name === action.data.quest.name && q.timestamp === action.data.quest.timestamp
                    );
                    if (questIdx !== -1) {
                        gameState.quests.splice(questIdx, 1);
                    }
                    break;
                case 'purchase':
                    gameState.gold = action.data.gold;
                    gameState.shards = action.data.shards;
                    break;
                case 'craft':
                    gameState.shards = action.data.shards;
                    gameState.gear.pop();
                    break;
            }
            
            saveGame();
            updateUI();
            showNotification('Action undone', 'success');
        }

        function resetSystem() {
            if (!confirm('Are you sure you want to reset the entire system? This cannot be undone!')) {
                return;
            }
            
            if (!confirm('FINAL WARNING: All progress will be lost. Continue?')) {
                return;
            }
            
            localStorage.removeItem('sovereignZenith');
            location.reload();
        }

        // Quest System
        const rankMultipliers = {
            'E': 1,
            'D': 3,      // Reduced from 5
            'C': 6,      // Reduced from 10
            'B': 12,     // Reduced from 20
            'A': 20,     // Reduced from 35
            'S': 35      // Reduced from 50
        };

        function renderQuests() {
            const questList = document.getElementById('questList');
            let filtered = gameState.quests.filter(q => q.type === gameState.questMode);
            
            if (filtered.length === 0) {
                questList.innerHTML = '<p class="text-gray-400 text-center py-4">No missions available</p>';
                return;
            }
            
            // Apply sorting
            if (gameState.questSort === 'rank') {
                const rankOrder = { 'S': 0, 'A': 1, 'B': 2, 'C': 3, 'D': 4, 'E': 5 };
                filtered.sort((a, b) => rankOrder[a.rank] - rankOrder[b.rank]);
            } else if (gameState.questSort === 'time') {
                filtered.sort((a, b) => (a.expiresAt || Infinity) - (b.expiresAt || Infinity));
            } else if (gameState.questSort === 'stat') {
                filtered.sort((a, b) => {
                    if (a.statType === 'none') return 1;
                    if (b.statType === 'none') return -1;
                    return a.statType.localeCompare(b.statType);
                });
            }
            
            const now = Date.now();
            const inBulkMode = gameState.bulkSelectMode;
            
            questList.innerHTML = filtered.map((q, idx) => {
                const statBonus = q.statType && q.statType !== 'none' ? ` | +${q.statBonus} ${q.statType.toUpperCase()}` : '';
                const timeLeft = q.expiresAt ? Math.max(0, Math.ceil((q.expiresAt - now) / 1000 / 60 / 60)) : null;
                const timeWarning = timeLeft !== null && timeLeft < 6 ? 'text-red-400' : 'text-gray-400';
                const isSelected = gameState.selectedQuests.has(idx);
                
                return `
                <div class="glass rounded p-3 ${isSelected ? 'ring-2 ring-blue-500' : ''}">
                    <div class="flex justify-between items-start gap-2">
                        ${inBulkMode ? `
                        <div class="flex items-center">
                            <input type="checkbox" 
                                   ${isSelected ? 'checked' : ''} 
                                   onchange="toggleQuestSelect(${idx})"
                                   class="w-5 h-5 cursor-pointer">
                        </div>` : ''}
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <span class="rank-${q.rank.toLowerCase()} font-bold">[${q.rank}]</span>
                                <span class="text-white">${q.name}</span>
                            </div>
                            <div class="text-xs text-gray-400 mt-1">
                                +${q.xp} XP | +${q.gold} Gold | +${q.fatigue}% Fatigue${statBonus}
                            </div>
                            ${timeLeft !== null ? `<div class="text-xs ${timeWarning} mt-1">‚è±Ô∏è ${timeLeft}h left (Fail: -${Math.floor(q.xp * 0.5)} XP)</div>` : ''}
                        </div>
                        ${!inBulkMode ? `
                        <div class="flex flex-col gap-1">
                            <button onclick="completeQuest(${idx})" class="px-3 py-1 bg-green-600 hover:bg-green-700 text-white rounded text-sm whitespace-nowrap">
                                ‚úì Complete
                            </button>
                            <button onclick="saveQuestAsTemplate(${idx})" class="px-3 py-1 bg-purple-600 hover:bg-purple-700 text-white rounded text-xs" title="Save as Template">
                                üíæ
                            </button>
                            <button onclick="deleteQuest(${idx})" class="px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-xs">
                                üóëÔ∏è
                            </button>
                        </div>` : ''}
                    </div>
                </div>
            `;
            }).join('');
        }
        
        function toggleQuestSelect(idx) {
            if (gameState.selectedQuests.has(idx)) {
                gameState.selectedQuests.delete(idx);
            } else {
                gameState.selectedQuests.add(idx);
            }
            updateUI();
        }
        
        
        function saveQuestAsTemplate(index) {
            const quest = gameState.quests.filter(q => q.type === gameState.questMode)[index];
            if (!quest) return;
            
            const template = {
                name: quest.name,
                rank: quest.rank,
                statType: quest.statType,
                type: quest.type
            };
            
            // Check if template already exists
            const exists = gameState.savedQuests.some(t => t.name === template.name);
            if (exists) {
                showNotification(`Template "${quest.name}" already exists!`, 'error');
                return;
            }
            
            gameState.savedQuests.push(template);
            saveGame();
            updateUI();
            showNotification(`üíæ Saved "${quest.name}" as template!`, 'success');
        }
        
        function deleteQuest(index) {
            const quest = gameState.quests.filter(q => q.type === gameState.questMode)[index];
            if (!quest) return;
            
            if (!confirm(`Delete "${quest.name}"?`)) return;
            
            const actualIndex = gameState.quests.indexOf(quest);
            gameState.quests.splice(actualIndex, 1);
            
            saveGame();
            updateUI();
            showNotification('Quest deleted', 'info');
        }

        function addQuest() {
            const name = document.getElementById('questName').value.trim();
            const rank = document.getElementById('questRank').value;
            const statType = document.getElementById('questStatType').value;
            const autoSave = document.getElementById('autoSaveTemplate').checked;
            
            if (!name) {
                showNotification('Enter a mission name', 'error');
                return;
            }
            
            // Check for duplicate quest (same name and type)
            const duplicate = gameState.quests.find(q => 
                q.name.toLowerCase() === name.toLowerCase() && 
                q.type === gameState.questMode
            );
            
            if (duplicate) {
                showNotification(`Quest "${name}" already exists in ${gameState.questMode} quests!`, 'error');
                return;
            }
            
            const multiplier = rankMultipliers[rank];
            const typeMultiplier = gameState.questMode === 'longterm' ? 10 : 1;
            const statBonus = multiplier * 2; // Stat bonus scales with rank
            
            // Daily quests expire at midnight, long-term quests expire in 7 days
            let expiresAt;
            if (gameState.questMode === 'daily') {
                const midnight = new Date();
                midnight.setHours(23, 59, 59, 999);
                // If midnight is in the past (already passed today), set to tomorrow's midnight
                if (midnight.getTime() < Date.now()) {
                    midnight.setDate(midnight.getDate() + 1);
                }
                expiresAt = midnight.getTime();
            } else {
                expiresAt = Date.now() + (7 * 24 * 60 * 60 * 1000);
            }
            
            const quest = {
                name,
                rank,
                type: gameState.questMode,
                xp: 30 * multiplier * typeMultiplier,      // Reduced from 50
                gold: 15 * multiplier * typeMultiplier,    // Reduced from 20
                fatigue: 3 * multiplier,                   // Reduced from 5
                statType: statType,
                statBonus: statBonus,
                timestamp: Date.now(),
                expiresAt: expiresAt,
                accepted: true // Quest is accepted when added
            };
            
            gameState.quests.push(quest);
            
            // Auto-save as template if checkbox is checked
            if (autoSave) {
                const template = {
                    name: quest.name,
                    rank: quest.rank,
                    statType: quest.statType,
                    type: quest.type
                };
                
                // Check if template already exists
                const exists = gameState.savedQuests.some(t => t.name === template.name);
                if (!exists) {
                    gameState.savedQuests.push(template);
                    showNotification(`‚úì Quest added & saved as template!`, 'success');
                } else {
                    showNotification(`‚úì Quest added (template already exists)`, 'success');
                }
            } else {
                showNotification(`Mission added: ${name}`, 'success');
            }
            
            // Save action for undo
            saveAction('addQuest', { quest });
            
            document.getElementById('questName').value = '';
            saveGame();
            updateUI();
            
            // Force render quests immediately (in case tab isn't active)
            renderQuests();
        }

        // Check for expired quests and apply penalties
        function checkQuestExpiration() {
            const now = Date.now();
            const expiredQuests = gameState.quests.filter(q => q.accepted && q.expiresAt && now > q.expiresAt);
            
            if (expiredQuests.length > 0) {
                expiredQuests.forEach(quest => {
                    // Apply 50% XP penalty and HP damage
                    const xpPenalty = Math.floor(quest.xp * 0.5);
                    const hpDamage = 10;
                    
                    gameState.xp = Math.max(0, gameState.xp - xpPenalty);
                    gameState.hp = Math.max(0, gameState.hp - hpDamage);
                    
                    // Track statistics
                    trackQuestFailed();
                    
                    // Log the failure
                    gameState.logs.push({
                        timestamp: Date.now(),
                        text: `Quest Failed: "${quest.name}" - Penalty: -${xpPenalty} XP, -${hpDamage} HP`
                    });
                    
                    showNotification(`‚ö†Ô∏è Quest Expired: ${quest.name} (-${xpPenalty} XP, -${hpDamage} HP)`, 'error');
                    speakSystem('Quest failure detected. Penalty applied.');
                    
                    // Remove expired quest
                    const idx = gameState.quests.indexOf(quest);
                    if (idx !== -1) {
                        gameState.quests.splice(idx, 1);
                    }
                });
                
                // Check if HP reached 0
                if (gameState.hp <= 0) {
                    gameState.hp = 0;
                    gameState.penaltyUntil = Date.now() + (4 * 60 * 60 * 1000);
                    speakSystem('Critical health reached. Penalty zone activated.');
                    showPenaltyScreen();
                }
                
                saveGame();
                updateUI();
            }
        }

        function completeQuest(idx) {
            const allQuests = gameState.quests.filter(q => q.type === gameState.questMode);
            const quest = allQuests[idx];
            const globalIdx = gameState.quests.indexOf(quest);
            
            // Check quest chain before completing
            if (quest && typeof checkQuestChain === 'function') {
                checkQuestChain(quest.name);
            }
            
            // Save state for undo
            saveAction('completeQuest', {
                xp: gameState.xp,
                gold: gameState.gold,
                fatigue: gameState.fatigue,
                str: gameState.str,
                int: gameState.int,
                agi: gameState.agi,
                sen: gameState.sen,
                level: gameState.level,
                quest: quest
            });
            
            // Update combo
            const now = Date.now();
            const timeSinceLastQuest = gameState.lastQuestCompleteTime ? now - gameState.lastQuestCompleteTime : 999999;
            
            if (timeSinceLastQuest < 5 * 60 * 1000) {
                gameState.comboCount++;
                if (gameState.comboCount === 3) {
                    showNotification('üî• COMBO x3! +10% Rewards', 'legendary');
                    speakSystem('Combo activated!');
                } else if (gameState.comboCount === 5) {
                    showNotification('üî• COMBO x5! +25% Rewards', 'legendary');
                    speakSystem('Combo rising!');
                } else if (gameState.comboCount === 10) {
                    showNotification('üî• COMBO x10! +50% Rewards', 'legendary');
                    speakSystem('Maximum combo achieved!');
                }
            } else {
                gameState.comboCount = 1;
            }
            
            gameState.lastQuestCompleteTime = now;
            
            // Apply combo multiplier
            const comboMultiplier = getComboMultiplier();
            
            // Apply mode multipliers
            let xpMultiplier = comboMultiplier;
            let goldMultiplier = gameState.goldMultiplier * comboMultiplier;
            let fatigueMultiplier = (gameState.jobClass === 'assassin' ? 0.75 : 1);
            
            // STEALTH MODE: -50% fatigue cost, but -25% XP
            if (gameState.stealthMode) {
                fatigueMultiplier *= 0.5;
                xpMultiplier *= 0.75; // 25% XP reduction
            }
            
            // BLOODLUST MODE: +75% XP and Gold, but 2x fatigue cost
            if (gameState.bloodlustMode) {
                xpMultiplier *= 1.75;
                goldMultiplier *= 1.75;
                fatigueMultiplier *= 2; // Double fatigue cost
            }
            
            // DOMAIN EXPANSION: 3x XP, 3x Gold, 0 fatigue (one-time)
            if (gameState.domainActive) {
                xpMultiplier *= 3;
                goldMultiplier *= 3;
                fatigueMultiplier = 0; // No fatigue!
                gameState.domainActive = false; // Consumed
                showNotification('‚ö° DOMAIN CONSUMED! 3x rewards applied!', 'legendary');
            }
            
            const xpGained = quest.xp * xpMultiplier;
            const goldGained = quest.gold * goldMultiplier;
            const fatigueGained = quest.fatigue * fatigueMultiplier;
            
            addXP(xpGained);
            gameState.gold += goldGained;
            gameState.fatigue += fatigueGained;
            
            // Auto-turn off Stealth and Bloodlust after quest completion
            if (gameState.stealthMode) {
                gameState.stealthMode = false;
                document.body.style.filter = '';
                showNotification('üåë Stealth Mode auto-deactivated', 'info');
            }
            if (gameState.bloodlustMode) {
                gameState.bloodlustMode = false;
                document.body.style.filter = '';
                showNotification('üíÄ Bloodlust Mode auto-deactivated', 'info');
            }
            
            // Track statistics
            trackQuestComplete(quest, xpGained, goldGained);
            
            // Recover HP
            gameState.hp = Math.min(gameState.maxHP, gameState.hp + 5);
            
            // Apply stat bonus if applicable
            if (quest.statType && quest.statType !== 'none') {
                const statBonus = quest.statBonus * (gameState.jobClass === 'berserker' && quest.statType === 'str' ? 2 :
                                                      gameState.jobClass === 'assassin' && quest.statType === 'agi' ? 2 :
                                                      gameState.jobClass === 'sage' && quest.statType === 'int' ? 2 : 1);
                gameState[quest.statType] += statBonus;
                showNotification(`+${statBonus} ${quest.statType.toUpperCase()}!`, 'success');
            }
            
            // S-Rank has 1% chance to drop Architect's Key
            if (quest.rank === 'S' && Math.random() < 0.01) {
                gameState.keys++;
                showNotification('üîë ARCHITECT\'S KEY ACQUIRED!', 'legendary');
                speakSystem('Architect key acquired.');
                spawnGlitchGate();
            }
            
            // Check fatigue
            if (gameState.fatigue >= 100) {
                gameState.penaltyUntil = Date.now() + (4 * 60 * 60 * 1000); // 4 hours
                gameState.fatigue = 100;
                speakSystem('Warning. Penalty zone activated.');
                saveGame();
                showPenaltyScreen();
                return;
            }
            
            gameState.quests.splice(globalIdx, 1);
            saveGame();
            updateUI();
            showNotification(`Mission complete: ${quest.name}`, 'success');
        }

        // Shadow Army
        function renderShadows() {
            const shadowList = document.getElementById('shadowList');
            if (gameState.shadows.length === 0) {
                shadowList.innerHTML = '<p class="text-gray-400 text-center py-4">No shadows in your army</p>';
                document.getElementById('armyPower').textContent = '0';
                document.getElementById('passiveIncome').textContent = '0';
                return;
            }
            
            const totalPower = gameState.shadows.reduce((sum, s) => sum + s.power, 0);
            const jobBonus = gameState.jobClass === 'necromancer' ? 1.5 : 1;
            document.getElementById('armyPower').textContent = Math.floor(totalPower * jobBonus);
            document.getElementById('passiveIncome').textContent = Math.floor(totalPower * jobBonus / 10);
            
            shadowList.innerHTML = gameState.shadows.map((s, idx) => {
                // Update shadow with current rank
                s.rank = getShadowRank(s.power);
                s.stars = getShadowStars(s.rank);
                
                return `
                <div class="glass rounded p-3 arise-animation">
                    <div class="flex justify-between items-center">
                        <div>
                            <span class="text-blue-400 font-bold">${s.name}</span>
                            <span class="text-cyan-300 text-sm ml-2">[${s.rank}] ${s.stars}</span>
                        </div>
                        <div class="text-yellow-400">Power: ${s.power}</div>
                    </div>
                    ${s.gear ? `<div class="text-xs text-gray-400 mt-1">Equipped: ${s.gear}</div>` : ''}
                </div>
            `;
            }).join('');
            
            // Update fusion dropdowns
            updateFusionDropdowns();
        }

        function updateFusionDropdowns() {
            const select1 = document.getElementById('fusionShadow1');
            const select2 = document.getElementById('fusionShadow2');
            
            const options = gameState.shadows.map((s, idx) => 
                `<option value="${idx}">${s.name} (${s.power})</option>`
            ).join('');
            
            select1.innerHTML = '<option value="">Select Shadow 1</option>' + options;
            select2.innerHTML = '<option value="">Select Shadow 2</option>' + options;
        }

        // Gear System
        function renderGear() {
            const gearList = document.getElementById('gearList');
            if (gameState.gear.length === 0) {
                gearList.innerHTML = '<p class="text-gray-400 text-center py-4">No gear crafted</p>';
                return;
            }
            
            gearList.innerHTML = gameState.gear.map((g, idx) => `
                <div class="glass rounded p-3 flex justify-between items-center arise-animation">
                    <div>
                        <span class="text-cyan-300 font-bold">${g.name}</span>
                        <span class="text-blue-400 text-sm ml-2">+${g.power} Power</span>
                    </div>
                    <select onchange="equipGear(${idx}, this.value)" class="bg-gray-800 text-white px-2 py-1 rounded text-sm">
                        <option value="">Equip to...</option>
                        ${gameState.shadows.map((s, sidx) => 
                            `<option value="${sidx}" ${s.gear === g.name ? 'selected' : ''}>${s.name}</option>`
                        ).join('')}
                    </select>
                </div>
            `).join('');
        }

        function craftGear() {
            const name = document.getElementById('gearName').value.trim();
            const power = parseInt(document.getElementById('gearPower').value);
            
            if (!name || !power || power < 1 || power > 100) {
                showNotification('Invalid gear parameters', 'error');
                return;
            }
            
            if (gameState.shards < 5) {
                showNotification('Need 5 Soul Shards', 'error');
                return;
            }
            
            gameState.shards -= 5;
            gameState.gear.push({ name, power });
            document.getElementById('gearName').value = '';
            document.getElementById('gearPower').value = '';
            saveGame();
            updateUI();
            showNotification(`Forged: ${name}`, 'success');
        }

        function equipGear(gearIdx, shadowIdx) {
            if (!shadowIdx) return;
            
            const gear = gameState.gear[gearIdx];
            const shadow = gameState.shadows[shadowIdx];
            
            // Remove gear from other shadows
            gameState.shadows.forEach(s => {
                if (s.gear === gear.name) {
                    s.gear = null;
                    s.power -= gear.power;
                }
            });
            
            shadow.gear = gear.name;
            shadow.power += gear.power;
            saveGame();
            updateUI();
            showNotification(`Equipped ${gear.name} to ${shadow.name}`, 'success');
        }

        // World Boss System
        function spawnWorldBoss() {
            const bossNames = ['Titan of Shadows', 'Void Devourer', 'Crimson Sovereign', 'Eclipse Dragon'];
            const name = bossNames[Math.floor(Math.random() * bossNames.length)];
            
            gameState.currentBoss = {
                name,
                maxHP: gameState.level * 1000,
                currentHP: gameState.level * 1000
            };
            
            saveGame();
            updateUI();
            showNotification(`WORLD BOSS SPAWNED: ${name}!`, 'legendary');
        }

        function updateBoss() {
            const container = document.getElementById('bossContainer');
            
            if (!gameState.currentBoss) {
                container.innerHTML = '<p class="text-gray-400 text-center py-8">No world boss available.</p>';
                return;
            }
            
            const boss = gameState.currentBoss;
            const hpPercent = (boss.currentHP / boss.maxHP * 100);
            
            container.innerHTML = `
                <div class="glass rounded-lg p-4 neon-border">
                    <h3 class="text-2xl font-bold text-red-400 text-center mb-4">${boss.name}</h3>
                    <div class="mb-2">
                        <div class="flex justify-between text-sm text-white mb-1">
                            <span>HP</span>
                            <span>${boss.currentHP} / ${boss.maxHP}</span>
                        </div>
                        <div class="w-full bg-gray-800 rounded-full h-6 overflow-hidden">
                            <div class="hp-bar" style="width: ${hpPercent}%"></div>
                        </div>
                    </div>
                    <button onclick="attackBoss()" class="w-full bg-red-600 hover:bg-red-700 text-white px-4 py-3 rounded font-bold mt-4">
                        ‚öîÔ∏è ATTACK
                    </button>
                </div>
            `;
        }

        function attackBoss() {
            if (!gameState.currentBoss) return;
            
            const playerDamage = gameState.str + gameState.agi + Math.floor(Math.random() * 50);
            gameState.currentBoss.currentHP -= playerDamage;
            
            // BOSS COUNTER-ATTACKS! Takes your HP
            const bossDamage = Math.floor(gameState.currentBoss.maxHP / 20) + Math.floor(Math.random() * 10);
            gameState.hp -= bossDamage;
            
            // Check if PLAYER is defeated first
            if (gameState.hp <= 0) {
                gameState.hp = 0;
                const boss = gameState.currentBoss;
                
                // BOSS DEFEAT PENALTY: Lose 50% of potential boss XP
                const xpLoss = Math.floor(boss.maxHP * 0.5);
                gameState.xp = Math.max(0, gameState.xp - xpLoss);
                
                // Apply penalty zone (4 hours)
                gameState.penaltyUntil = Date.now() + (4 * 60 * 60 * 1000);
                
                // Boss disappears (you failed)
                gameState.currentBoss = null;
                
                // Track failure
                if (!gameState.stats) gameState.stats = {};
                gameState.stats.bossesLost = (gameState.stats.bossesLost || 0) + 1;
                
                // Log defeat
                gameState.logs.push({
                    timestamp: Date.now(),
                    text: `DEFEATED by ${boss.name}! Penalty: -${xpLoss} XP, HP critical, 4-hour penalty zone`
                });
                
                showNotification(`üíÄ DEFEATED! ${boss.name} overwhelmed you! -${xpLoss} XP, 4-hour penalty!`, 'error');
                speakSystem('Boss battle lost. Critical damage sustained.');
                showPenaltyScreen();
                
                saveGame();
                updateUI();
                return;
            }
            
            // Check if BOSS is defeated
            if (gameState.currentBoss.currentHP <= 0) {
                const boss = gameState.currentBoss;
                gameState.currentBoss = null;
                
                // Apply mode multipliers to boss rewards
                let xpMultiplier = 1;
                let goldMultiplier = 1;
                
                // BLOODLUST: +75% XP & Gold
                if (gameState.bloodlustMode) {
                    xpMultiplier *= 1.75;
                    goldMultiplier *= 1.75;
                    gameState.bloodlustMode = false; // Auto-off after boss
                    document.body.style.filter = '';
                    showNotification('üíÄ Bloodlust consumed by boss battle!', 'info');
                }
                
                // DOMAIN: 3x XP & Gold
                if (gameState.domainActive) {
                    xpMultiplier *= 3;
                    goldMultiplier *= 3;
                    gameState.domainActive = false; // Auto-off after boss
                    showNotification('‚ö° DOMAIN consumed by boss battle!', 'legendary');
                }
                
                // STEALTH: No effect on bosses (can't stealth a boss fight!)
                if (gameState.stealthMode) {
                    gameState.stealthMode = false;
                    document.body.style.filter = '';
                    showNotification('üåë Stealth ended (no effect on boss battles)', 'info');
                }
                
                // Track statistics
                trackBossDefeated();
                trackShadowExtracted();
                
                // Trigger Arise
                playSound('arise');
                document.getElementById('app').classList.add('domain-expansion');
                setTimeout(() => document.getElementById('app').classList.remove('domain-expansion'), 500);
                
                // Create shadow from boss
                gameState.shadows.push({
                    name: boss.name,
                    power: Math.floor(boss.maxHP / 10),
                    grade: 'Elite',
                    gear: null
                });
                
                const xpGained = Math.floor(boss.maxHP * xpMultiplier);
                const goldGained = Math.floor(boss.maxHP * goldMultiplier);
                
                gameState.gold += goldGained;
                addXP(xpGained);
                
                showNotification(`‚öîÔ∏è VICTORY! ${boss.name} defeated! Gained ${xpGained} XP & ${goldGained} Gold. ARISE!`, 'legendary');
                speakSystem(`Arise, ${boss.name}`);
            } else {
                // Battle continues - show damage dealt
                showNotification(`‚öîÔ∏è Dealt ${playerDamage} damage! Boss HP: ${gameState.currentBoss.currentHP}/${gameState.currentBoss.maxHP}. You took ${bossDamage} damage!`, 'info');
            }
            
            saveGame();
            updateUI();
        }

        // Glitch Gate System
        function spawnGlitchGate() {
            if (gameState.keys < 1) return;
            
            const gate = {
                id: Date.now(),
                name: `Corrupted Rift ${gameState.glitchGates.length + 1}`,
                reward: 'Ancient Grade Shadow'
            };
            
            gameState.glitchGates.push(gate);
            saveGame();
            updateUI();
        }

        function updateGlitchGates() {
            const container = document.getElementById('glitchContainer');
            
            if (gameState.glitchGates.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-8">No Glitch Gates available. Acquire Architect\'s Keys from S-Rank missions.</p>';
                return;
            }
            
            // Calculate success chance
            const totalPower = gameState.str + gameState.int + gameState.agi + gameState.sen;
            const requiredPower = gameState.level * 50;
            const successChance = Math.min(90, Math.max(30, (totalPower / requiredPower) * 100));
            
            const chanceColor = successChance >= 70 ? 'text-green-400' : 
                               successChance >= 50 ? 'text-yellow-400' : 'text-red-400';
            
            container.innerHTML = gameState.glitchGates.map((g, idx) => `
                <div class="glass rounded-lg p-4 mb-4 glitch-gate">
                    <h3 class="text-xl font-bold text-red-400 mb-2">${g.name}</h3>
                    <p class="text-purple-300 mb-2">Reward: ${g.reward}</p>
                    <div class="mb-3 text-sm">
                        <div class="flex justify-between mb-1">
                            <span class="text-gray-400">Success Chance:</span>
                            <span class="${chanceColor} font-bold">${Math.floor(successChance)}%</span>
                        </div>
                        <div class="text-xs text-gray-500">
                            Success: Ancient Shadow, +${gameState.level * 100} XP, +${gameState.level * 50} Gold<br>
                            Failure: -${Math.floor(gameState.level * 50)} XP, -30 HP, Key lost
                        </div>
                    </div>
                    <button onclick="enterGlitchGate(${idx})" class="w-full bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded font-bold">
                        üîë ENTER GATE (High Risk!)
                    </button>
                </div>
            `).join('');
        }

        function enterGlitchGate(idx) {
            if (gameState.keys < 1) {
                showNotification('Need Architect\'s Key', 'error');
                return;
            }
            
            gameState.keys--;
            const gate = gameState.glitchGates[idx];
            
            // Calculate success chance based on total stats
            const totalPower = gameState.str + gameState.int + gameState.agi + gameState.sen;
            const requiredPower = gameState.level * 50; // Scales with level
            let successChance = Math.min(90, Math.max(30, (totalPower / requiredPower) * 100));
            
            // STEALTH MODE: +10% success chance
            if (gameState.stealthMode) {
                successChance = Math.min(95, successChance + 10);
                showNotification('üåë Stealth active: +10% success chance!', 'info');
            }
            
            const roll = Math.random() * 100;
            
            if (roll < successChance) {
                // SUCCESS! Get Ancient Shadow
                gameState.shadows.push({
                    name: `Ancient ${['Warrior', 'Assassin', 'Mage', 'Knight'][Math.floor(Math.random() * 4)]}`,
                    power: 500 + Math.floor(Math.random() * 500),
                    grade: 'Ancient',
                    gear: null
                });
                
                // Apply mode multipliers to glitch gate rewards
                let xpMultiplier = 1;
                let goldMultiplier = 1;
                
                // BLOODLUST: +75% XP & Gold
                if (gameState.bloodlustMode) {
                    xpMultiplier *= 1.75;
                    goldMultiplier *= 1.75;
                    gameState.bloodlustMode = false;
                    document.body.style.filter = '';
                    showNotification('üíÄ Bloodlust consumed by glitch gate!', 'info');
                }
                
                // DOMAIN: 3x XP & Gold
                if (gameState.domainActive) {
                    xpMultiplier *= 3;
                    goldMultiplier *= 3;
                    gameState.domainActive = false;
                    showNotification('‚ö° DOMAIN consumed by glitch gate!', 'legendary');
                }
                
                // STEALTH: +10% success chance bonus!
                // (Already applied above in calculation, consumed here)
                if (gameState.stealthMode) {
                    gameState.stealthMode = false;
                    document.body.style.filter = '';
                    showNotification('üåë Stealth consumed by glitch gate!', 'info');
                }
                
                // Bonus rewards with multipliers
                const bonusXP = Math.floor(gameState.level * 100 * xpMultiplier);
                const bonusGold = Math.floor(gameState.level * 50 * goldMultiplier);
                addXP(bonusXP);
                gameState.gold += bonusGold;
                
                gameState.glitchGates.splice(idx, 1);
                
                gameState.logs.push({
                    timestamp: Date.now(),
                    text: `Conquered ${gate.name}! Acquired Ancient Shadow, +${bonusXP} XP, +${bonusGold} Gold`
                });
                
                showNotification(`‚ú® SUCCESS! Acquired Ancient Shadow from ${gate.name}! +${bonusXP} XP, +${bonusGold} Gold`, 'legendary');
                speakSystem('Glitch gate conquered. Ancient shadow acquired.');
            } else {
                // FAILURE! Lose XP and HP
                const xpLoss = Math.floor(gameState.level * 50);
                const hpLoss = 30;
                
                gameState.xp = Math.max(0, gameState.xp - xpLoss);
                gameState.hp = Math.max(0, gameState.hp - hpLoss);
                
                gameState.glitchGates.splice(idx, 1);
                
                // Track failure
                if (!gameState.stats) gameState.stats = {};
                gameState.stats.glitchGatesFailed = (gameState.stats.glitchGatesFailed || 0) + 1;
                
                gameState.logs.push({
                    timestamp: Date.now(),
                    text: `FAILED ${gate.name}! Corrupted dimension collapsed. Penalty: -${xpLoss} XP, -${hpLoss} HP, Key lost`
                });
                
                showNotification(`üíÄ FAILURE! ${gate.name} collapsed! -${xpLoss} XP, -${hpLoss} HP, Key consumed!`, 'error');
                speakSystem('Glitch gate failure. Dimension corrupted.');
                
                // Check if HP reached 0
                if (gameState.hp <= 0) {
                    gameState.hp = 0;
                    gameState.penaltyUntil = Date.now() + (4 * 60 * 60 * 1000);
                    showPenaltyScreen();
                }
            }
            
            saveGame();
            updateUI();
        }

        // Chronicle System
        function renderLogs() {
            const logList = document.getElementById('logList');
            if (gameState.logs.length === 0) {
                logList.innerHTML = '<p class="text-gray-400 text-center py-4">No entries yet</p>';
                return;
            }
            
            logList.innerHTML = gameState.logs.map(log => `
                <div class="glass rounded p-3">
                    <div class="text-xs text-gray-400 mb-1">${new Date(log.timestamp).toLocaleString()}</div>
                    <div class="text-white">${log.text}</div>
                </div>
            `).join('');
        }

        function addLog() {
            const text = document.getElementById('logEntry').value.trim();
            if (!text) return;
            
            gameState.logs.push({
                timestamp: Date.now(),
                text
            });
            
            document.getElementById('logEntry').value = '';
            saveGame();
            updateUI();
        }

        function exportJourney() {
            let output = '=== SOVEREIGN ZENITH - MONARCH\'S JOURNEY ===\n\n';
            output += `Level: ${gameState.level}\n`;
            output += `Stats: STR ${gameState.str} | INT ${gameState.int} | AGI ${gameState.agi} | SEN ${gameState.sen}\n`;
            output += `Gold: ${gameState.gold} | Soul Shards: ${gameState.shards}\n\n`;
            
            output += '=== SHADOW LEGION ===\n';
            gameState.shadows.forEach(s => {
                output += `${s.name} [${s.grade}] - Power: ${s.power}${s.gear ? ` | Gear: ${s.gear}` : ''}\n`;
            });
            
            output += '\n=== CHRONICLE ===\n';
            gameState.logs.forEach(log => {
                output += `[${new Date(log.timestamp).toLocaleString()}] ${log.text}\n`;
            });
            
            const blob = new Blob([output], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sovereign_zenith_journey.txt';
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('Journey exported!', 'success');
        }

        // Achievement System
        const achievementDefinitions = [
            { id: 'first_shadow', name: 'First Extraction', desc: 'Extract your first shadow', reward: 'x1.5 Gold', check: () => gameState.shadows.length >= 1 },
            { id: 'level_10', name: 'Rising Hunter', desc: 'Reach Level 10', reward: 'x1.2 XP', check: () => gameState.level >= 10 },
            { id: 'level_50', name: 'S-Rank Hunter', desc: 'Reach Level 50', reward: 'x2 Gold', check: () => gameState.level >= 50 },
            { id: 'shadow_army', name: 'Shadow Legion', desc: 'Command 10 shadows', reward: 'x1.5 XP', check: () => gameState.shadows.length >= 10 },
            { id: 'gold_master', name: 'Golden Monarch', desc: 'Accumulate 10,000 gold', reward: 'x2 Gold', check: () => gameState.gold >= 10000 },
            { id: 'shard_collector', name: 'Soul Collector', desc: 'Collect 100 shards', reward: '+50 All Stats', check: () => gameState.shards >= 100 },
            { id: 'boss_slayer', name: 'Boss Slayer', desc: 'Defeat a World Boss', reward: 'x1.5 All Stats', check: () => gameState.logs.some(log => log.text && log.text.includes('ARISE')) },
            { id: 'architect', name: 'Architect\'s Chosen', desc: 'Acquire 5 Architect Keys', reward: 'x3 Gold', check: () => gameState.keys >= 5 }
        ];

        function checkAchievements() {
            let newAchievements = false;
            achievementDefinitions.forEach(achievement => {
                if (!gameState.achievements.includes(achievement.id) && achievement.check()) {
                    gameState.achievements.push(achievement.id);
                    applyAchievementReward(achievement);
                    showNotification(`üèÜ Achievement Unlocked: ${achievement.name}!`, 'legendary');
                    newAchievements = true;
                }
            });
            if (newAchievements) {
                saveGame();
            }
        }

        function applyAchievementReward(achievement) {
            if (achievement.reward.includes('Gold')) {
                const mult = parseFloat(achievement.reward.match(/x([\d.]+)/)[1]);
                gameState.goldMultiplier *= mult;
            } else if (achievement.reward.includes('XP')) {
                const mult = parseFloat(achievement.reward.match(/x([\d.]+)/)[1]);
                gameState.xpMultiplier *= mult;
            } else if (achievement.reward.includes('All Stats')) {
                const bonus = parseInt(achievement.reward.match(/\+(\d+)/)[1]);
                gameState.str += bonus;
                gameState.int += bonus;
                gameState.agi += bonus;
                gameState.sen += bonus;
            }
        }

        function renderAchievements() {
            const list = document.getElementById('achievementList');
            if (!list) return;
            
            list.innerHTML = achievementDefinitions.map(achievement => {
                const unlocked = gameState.achievements.includes(achievement.id);
                return `
                    <div class="glass rounded p-4 ${unlocked ? 'neon-border' : ''}">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h3 class="font-bold ${unlocked ? 'text-cyan-400' : 'text-gray-500'}">
                                    ${unlocked ? 'üèÜ' : 'üîí'} ${achievement.name}
                                </h3>
                                <p class="text-sm text-gray-400">${unlocked ? achievement.desc : '???'}</p>
                            </div>
                            <span class="text-xs ${unlocked ? 'text-yellow-400' : 'text-gray-600'}">
                                ${unlocked ? achievement.reward : 'Locked'}
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Evolution Tree System
        function upgradeEvolution(stat) {
            const costs = {
                str: 10, int: 10, agi: 10, sen: 10,
                goldBonus: 15, xpBonus: 15
            };
            
            const cost = costs[stat];
            const maxLevel = 10;
            
            if (gameState.evolutionTree[stat] >= maxLevel) {
                showNotification('Maximum level reached', 'error');
                return;
            }
            
            if (gameState.shards < cost) {
                showNotification('Not enough Shards', 'error');
                return;
            }
            
            gameState.shards -= cost;
            gameState.evolutionTree[stat]++;
            
            // Apply bonuses
            if (stat === 'str') gameState.str += 5;
            else if (stat === 'int') gameState.int += 5;
            else if (stat === 'agi') gameState.agi += 5;
            else if (stat === 'sen') gameState.sen += 5;
            else if (stat === 'goldBonus') gameState.goldMultiplier += 0.1;
            else if (stat === 'xpBonus') gameState.xpMultiplier += 0.1;
            
            saveGame();
            updateUI();
            showNotification(`Evolution upgraded: ${stat.toUpperCase()}`, 'success');
        }

        function updateEvolutionUI() {
            const stats = ['str', 'int', 'agi', 'sen'];
            stats.forEach(stat => {
                const elem = document.getElementById(`${stat}Evolution`);
                if (elem) elem.textContent = gameState.evolutionTree[stat];
            });
            
            const goldElem = document.getElementById('goldEvolution');
            if (goldElem) goldElem.textContent = gameState.evolutionTree.goldBonus;
            
            const xpElem = document.getElementById('xpEvolution');
            if (xpElem) xpElem.textContent = gameState.evolutionTree.xpBonus;
        }

        // Shadow Garden System
        function activateGarden() {
            if (gameState.shadowGarden.active) {
                showNotification('Garden already activated', 'error');
                return;
            }
            
            if (gameState.shards < 50) {
                showNotification('Need 50 Shards', 'error');
                return;
            }
            
            gameState.shards -= 50;
            gameState.shadowGarden.active = true;
            gameState.shadowGarden.lastCollected = Date.now();
            
            saveGame();
            updateUI();
            showNotification('üå± Shadow Garden Activated!', 'legendary');
        }

        function collectGarden() {
            if (!gameState.shadowGarden.active) return;
            
            const gold = gameState.shadowGarden.goldGenerated;
            gameState.gold += gold;
            gameState.shadowGarden.goldGenerated = 0;
            gameState.shadowGarden.lastCollected = Date.now();
            
            saveGame();
            updateUI();
            showNotification(`Collected ${gold} gold from Shadow Garden!`, 'success');
        }

        function updateGarden() {
            const statusElem = document.getElementById('gardenStatus');
            const goldElem = document.getElementById('gardenGold');
            const collectBtn = document.getElementById('collectGarden');
            
            if (!statusElem) return;
            
            if (gameState.shadowGarden.active) {
                statusElem.textContent = 'Active';
                statusElem.classList.add('text-green-400');
                statusElem.classList.remove('text-cyan-400');
                
                goldElem.textContent = Math.floor(gameState.shadowGarden.goldGenerated);
                
                if (collectBtn) {
                    collectBtn.disabled = gameState.shadowGarden.goldGenerated < 1;
                }
            } else {
                statusElem.textContent = 'Inactive';
                statusElem.classList.add('text-cyan-400');
                statusElem.classList.remove('text-green-400');
            }
        }

        // Monarch Skills System
        const skillDefinitions = {
            mutilate: { name: 'Mutilate', cost: 100, cooldown: 300000 },
            dragons_breath: { name: "Dragon's Breath", cost: 150, cooldown: 600000 },
            rulers_authority: { name: "Ruler's Authority", cost: 200, cooldown: 3600000 }
        };

        function unlockSkill(skillId) {
            const skill = skillDefinitions[skillId];
            if (gameState.monarchSkills.some(s => s.id === skillId)) {
                showNotification('Skill already unlocked', 'error');
                return;
            }
            
            if (gameState.shards < skill.cost) {
                showNotification('Not enough Shards', 'error');
                return;
            }
            
            gameState.shards -= skill.cost;
            gameState.monarchSkills.push({ id: skillId, lastUsed: 0 });
            
            saveGame();
            updateUI();
            showNotification(`Unlocked: ${skill.name}!`, 'legendary');
        }

        function useSkill(skillId) {
            const skill = skillDefinitions[skillId];
            const userSkill = gameState.monarchSkills.find(s => s.id === skillId);
            
            if (!userSkill) return;
            
            const now = Date.now();
            if (now - userSkill.lastUsed < skill.cooldown) {
                const remaining = Math.ceil((skill.cooldown - (now - userSkill.lastUsed)) / 1000 / 60);
                showNotification(`Cooldown: ${remaining} minutes`, 'error');
                return;
            }
            
            userSkill.lastUsed = now;
            
            if (skillId === 'mutilate' && gameState.currentBoss) {
                const damage = gameState.str * 3;
                gameState.currentBoss.currentHP -= damage;
                showNotification(`Mutilate dealt ${damage} damage!`, 'legendary');
            } else if (skillId === 'dragons_breath') {
                gameState.fatigue = Math.max(0, gameState.fatigue - 50);
                showNotification('Fatigue reduced by 50%!', 'success');
            } else if (skillId === 'rulers_authority') {
                gameState.fatigue += 20;
                showNotification("Ruler's Authority activated! 2x XP/Gold for 1 hour", 'legendary');
            }
            
            saveGame();
            updateUI();
        }

        function renderSkills() {
            const list = document.getElementById('skillList');
            if (!list) return;
            
            if (gameState.monarchSkills.length === 0) {
                list.innerHTML = '<p class="text-gray-400 text-center py-4">No skills unlocked</p>';
                return;
            }
            
            list.innerHTML = gameState.monarchSkills.map(userSkill => {
                const skill = skillDefinitions[userSkill.id];
                const now = Date.now();
                const onCooldown = now - userSkill.lastUsed < skill.cooldown;
                const remaining = Math.ceil((skill.cooldown - (now - userSkill.lastUsed)) / 1000 / 60);
                
                return `
                    <div class="glass rounded p-3 flex justify-between items-center">
                        <span class="text-cyan-400 font-bold">${skill.name}</span>
                        <button onclick="useSkill('${userSkill.id}')" 
                                class="px-3 py-1 bg-blue-600 hover:bg-blue-500 text-white rounded text-sm"
                                ${onCooldown ? 'disabled' : ''}>
                            ${onCooldown ? `${remaining}m` : 'Use'}
                        </button>
                    </div>
                `;
            }).join('');
        }

        // Red Gate Raid System
        function updateRaidDropdown() {
            const select = document.getElementById('raidShadow');
            if (!select) return;
            
            const availableShadows = gameState.shadows.filter(s => 
                !gameState.redGateRaids.some(r => r.shadowName === s.name && r.endTime > Date.now())
            );
            
            select.innerHTML = '<option value="">Select Shadow</option>' + 
                availableShadows.map((s, idx) => 
                    `<option value="${s.name}">${s.name} (${s.power})</option>`
                ).join('');
        }

        function startRaid() {
            const shadowName = document.getElementById('raidShadow').value;
            const difficulty = document.getElementById('raidDifficulty').value;
            
            if (!shadowName) {
                showNotification('Select a shadow', 'error');
                return;
            }
            
            const durations = { easy: 3600000, medium: 10800000, hard: 21600000, nightmare: 43200000 };
            const rewards = { 
                easy: { gold: 100, shards: 0 }, 
                medium: { gold: 500, shards: 0 }, 
                hard: { gold: 1500, shards: 0 }, 
                nightmare: { gold: 5000, shards: 10 } 
            };
            
            // STEALTH MODE: -20% raid duration (faster completion!)
            let durationMultiplier = 1;
            if (gameState.stealthMode) {
                durationMultiplier = 0.8; // 20% faster
                showNotification('üåë Stealth active: Raid 20% faster!', 'success');
            }
            
            const raid = {
                shadowName,
                difficulty,
                startTime: Date.now(),
                endTime: Date.now() + (durations[difficulty] * durationMultiplier),
                rewards: rewards[difficulty]
            };
            
            gameState.redGateRaids.push(raid);
            saveGame();
            updateUI();
            showNotification(`${shadowName} deployed to ${difficulty} gate!`, 'success');
        }

        function checkRaids() {
            const now = Date.now();
            const completedRaids = gameState.redGateRaids.filter(r => r.endTime <= now);
            
            completedRaids.forEach(raid => {
                // Apply mode multipliers to raid rewards
                let goldMultiplier = gameState.goldMultiplier;
                
                // BLOODLUST: +75% Gold
                if (gameState.bloodlustMode) {
                    goldMultiplier *= 1.75;
                    gameState.bloodlustMode = false;
                    document.body.style.filter = '';
                    showNotification('üíÄ Bloodlust consumed by raid completion!', 'info');
                }
                
                // DOMAIN: 3x Gold & Shards
                if (gameState.domainActive) {
                    goldMultiplier *= 3;
                    raid.rewards.shards *= 3;
                    gameState.domainActive = false;
                    showNotification('‚ö° DOMAIN consumed by raid completion!', 'legendary');
                }
                
                // STEALTH: -20% raid duration (applied when starting raid, not here)
                if (gameState.stealthMode) {
                    gameState.stealthMode = false;
                    document.body.style.filter = '';
                    showNotification('üåë Stealth ended', 'info');
                }
                
                gameState.gold += raid.rewards.gold * goldMultiplier;
                gameState.shards += raid.rewards.shards;
            });
            
            gameState.redGateRaids = gameState.redGateRaids.filter(r => r.endTime > now);
            
            if (completedRaids.length > 0) {
                saveGame();
            }
        }

        function renderRaids() {
            const list = document.getElementById('raidList');
            if (!list) return;
            
            const activeRaids = gameState.redGateRaids.filter(r => r.endTime > Date.now());
            
            if (activeRaids.length === 0) {
                list.innerHTML = '<p class="text-gray-400 text-center py-4">No active raids</p>';
                return;
            }
            
            list.innerHTML = activeRaids.map(raid => {
                const remaining = Math.ceil((raid.endTime - Date.now()) / 1000 / 60);
                return `
                    <div class="glass rounded p-3">
                        <div class="flex justify-between items-center">
                            <div>
                                <span class="text-purple-400 font-bold">${raid.shadowName}</span>
                                <span class="text-sm text-gray-400 ml-2">[${raid.difficulty}]</span>
                            </div>
                            <span class="text-cyan-400">${remaining}m</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Emergency Quest System with Weather API Integration
        const emergencyQuestTemplates = [
            {
                name: "Sudden Snowstorm",
                desc: "A heavy snowstorm has hit! Clear the snow from your driveway and walkways.",
                task: "Shovel snow from driveway",
                rank: "B",
                statType: "str",
                weatherTrigger: (weather) => weather.includes('snow') || weather.includes('Snow'),
                trigger: () => Math.random() < 0.03 // Reduced from 15%
            },
            {
                name: "Storm Preparation",
                desc: "A storm is approaching! Secure loose items and prepare emergency supplies.",
                task: "Storm-proof your home",
                rank: "A",
                statType: "sen",
                weatherTrigger: (weather) => weather.includes('storm') || weather.includes('Storm') || weather.includes('thunder'),
                trigger: () => Math.random() < 0.02 // Reduced from 10%
            },
            {
                name: "Heat Wave Challenge",
                desc: "Extreme heat detected! Stay hydrated and complete indoor tasks only.",
                task: "Drink 3L water + indoor workout",
                rank: "B",
                statType: "sen",
                weatherTrigger: (weather, temp) => temp > 35,
                trigger: () => Math.random() < 0.03 // Reduced from 12%
            },
            {
                name: "Rainy Day Tasks",
                desc: "Heavy rain outside. Perfect time for indoor productivity!",
                task: "Complete 2 hours of indoor work",
                rank: "C",
                statType: "int",
                weatherTrigger: (weather) => weather.includes('rain') || weather.includes('Rain'),
                trigger: () => Math.random() < 0.04 // Reduced from 20%
            },
            {
                name: "Early Morning Challenge",
                desc: "The System detects low activity. Wake up before 6 AM tomorrow!",
                task: "Wake up before 6:00 AM",
                rank: "C",
                statType: "sen",
                trigger: () => Math.random() < 0.04 // Reduced from 20%
            },
            {
                name: "Urgent Errands",
                desc: "Time-sensitive tasks detected! Complete 5 quick errands within 2 hours.",
                task: "Complete 5 errands quickly",
                rank: "B",
                statType: "agi",
                trigger: () => Math.random() < 0.15
            },
            {
                name: "Knowledge Crisis",
                desc: "Your mental stats are lagging! Read for 1 hour straight.",
                task: "Read for 60 minutes",
                rank: "C",
                statType: "int",
                trigger: () => Math.random() < 0.18
            },
            {
                name: "Physical Emergency",
                desc: "Emergency workout required! Complete 100 push-ups within the day.",
                task: "100 push-ups",
                rank: "A",
                statType: "str",
                trigger: () => Math.random() < 0.12
            },
            {
                name: "Speed Challenge",
                desc: "Time is of the essence! Run 5km in under 30 minutes.",
                task: "Run 5km < 30 min",
                rank: "A",
                statType: "agi",
                trigger: () => Math.random() < 0.10
            },
            {
                name: "Meditation Emergency",
                desc: "Your sense stat is depleted! Meditate for 30 minutes.",
                task: "Meditate for 30 minutes",
                rank: "D",
                statType: "sen",
                trigger: () => Math.random() < 0.20
            },
            {
                name: "Cleaning Crisis",
                desc: "Your environment affects your power! Deep clean your living space.",
                task: "Deep clean room/house",
                rank: "B",
                statType: "str",
                trigger: () => Math.random() < 0.15
            },
            {
                name: "Study Marathon",
                desc: "Urgent learning required! Study a new skill for 2 hours.",
                task: "Study new skill for 2 hours",
                rank: "B",
                statType: "int",
                trigger: () => Math.random() < 0.15
            },
            {
                name: "Hydration Alert",
                desc: "System detects dehydration! Drink 2L of water today.",
                task: "Drink 2 liters of water",
                rank: "E",
                statType: "sen",
                trigger: () => Math.random() < 0.25
            }
        ];

        // Get user's location for weather API
        async function getUserLocation() {
            return new Promise((resolve) => {
                if (gameState.userLocation) {
                    resolve(gameState.userLocation);
                    return;
                }
                
                if ('geolocation' in navigator) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            gameState.userLocation = {
                                lat: position.coords.latitude,
                                lon: position.coords.longitude
                            };
                            saveGame();
                            resolve(gameState.userLocation);
                        },
                        (error) => {
                            console.log('Location not available:', error);
                            resolve(null);
                        },
                        { timeout: 5000 }
                    );
                } else {
                    resolve(null);
                }
            });
        }

        // Fetch weather data using Open-Meteo API (free, no API key needed)
        async function getWeatherData() {
            try {
                const location = await getUserLocation();
                if (!location) return null;
                
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${location.lat}&longitude=${location.lon}&current=temperature_2m,weather_code&temperature_unit=celsius`;
                
                const response = await fetch(url);
                if (!response.ok) return null;
                
                const data = await response.json();
                
                // Weather codes: https://open-meteo.com/en/docs
                const weatherCodes = {
                    0: 'Clear',
                    1: 'Mainly Clear', 2: 'Partly Cloudy', 3: 'Overcast',
                    45: 'Fog', 48: 'Fog',
                    51: 'Light Drizzle', 53: 'Drizzle', 55: 'Heavy Drizzle',
                    61: 'Light Rain', 63: 'Rain', 65: 'Heavy Rain',
                    71: 'Light Snow', 73: 'Snow', 75: 'Heavy Snow',
                    77: 'Snow Grains',
                    80: 'Light Rain Showers', 81: 'Rain Showers', 82: 'Heavy Rain Showers',
                    85: 'Light Snow Showers', 86: 'Heavy Snow Showers',
                    95: 'Thunderstorm', 96: 'Thunderstorm with Hail', 99: 'Heavy Thunderstorm'
                };
                
                const weatherCode = data.current.weather_code;
                const temperature = data.current.temperature_2m;
                const weatherDesc = weatherCodes[weatherCode] || 'Unknown';
                
                return {
                    description: weatherDesc,
                    temperature: temperature,
                    code: weatherCode
                };
            } catch (error) {
                console.log('Weather fetch error:', error);
                return null;
            }
        }

        async function checkEmergencyQuest() {
            // Don't spawn if one already exists
            if (gameState.emergencyQuest) return;
            
            // Check only once every 4 hours
            const now = Date.now();
            if (gameState.lastEmergencyCheck && now - gameState.lastEmergencyCheck < 4 * 60 * 60 * 1000) {
                return;
            }
            
            gameState.lastEmergencyCheck = now;
            
            // Get weather data if available
            let weather = null;
            if (!gameState.lastWeatherCheck || now - gameState.lastWeatherCheck > 30 * 60 * 1000) {
                weather = await getWeatherData();
                gameState.lastWeatherCheck = now;
            }
            
            // Try to spawn weather-based emergency quest first
            if (weather) {
                for (const template of emergencyQuestTemplates) {
                    if (template.weatherTrigger && template.weatherTrigger(weather.description, weather.temperature)) {
                        spawnEmergencyQuest(template);
                        return;
                    }
                }
            }
            
            // Otherwise try random emergency quests
            for (const template of emergencyQuestTemplates) {
                if (!template.weatherTrigger && template.trigger()) {
                    spawnEmergencyQuest(template);
                    break;
                }
            }
        }

        function spawnEmergencyQuest(template) {
            const multiplier = rankMultipliers[template.rank];
            const now = Date.now();
            
            gameState.emergencyQuest = {
                name: template.name,
                desc: template.desc,
                task: template.task,
                rank: template.rank,
                statType: template.statType,
                xp: 100 * multiplier,
                gold: 50 * multiplier,
                fatigue: 8 * multiplier,
                statBonus: multiplier * 3,
                expiresAt: now + (6 * 60 * 60 * 1000), // 6 hours to complete
                spawnedAt: now
            };
            
            playSound('domain');
            showNotification('‚ö†Ô∏è EMERGENCY QUEST SPAWNED!', 'legendary');
            saveGame();
            updateUI();
        }

        function renderEmergencyQuest() {
            const panel = document.getElementById('emergencyQuestPanel');
            const content = document.getElementById('emergencyQuestContent');
            
            if (!panel || !content) return;
            
            if (!gameState.emergencyQuest) {
                panel.classList.add('hidden');
                return;
            }
            
            const quest = gameState.emergencyQuest;
            const now = Date.now();
            
            // Check if expired
            if (now > quest.expiresAt) {
                gameState.emergencyQuest = null;
                saveGame();
                panel.classList.add('hidden');
                showNotification('Emergency Quest expired!', 'error');
                return;
            }
            
            const remaining = Math.ceil((quest.expiresAt - now) / 1000 / 60);
            
            panel.classList.remove('hidden');
            content.innerHTML = `
                <div class="mb-4">
                    <h4 class="text-xl font-bold text-red-300 mb-2">${quest.name}</h4>
                    <p class="text-gray-300 text-sm mb-2">${quest.desc}</p>
                    <div class="glass rounded p-3 mb-3">
                        <div class="text-cyan-400 font-bold mb-1">Mission: ${quest.task}</div>
                        <div class="text-xs text-gray-400">
                            <span class="rank-${quest.rank.toLowerCase()} font-bold">[${quest.rank}]</span> | 
                            +${quest.xp} XP | +${quest.gold} Gold | +${quest.statBonus} ${quest.statType.toUpperCase()} | 
                            +${quest.fatigue}% Fatigue
                        </div>
                        <div class="text-yellow-400 text-sm mt-2">‚è±Ô∏è Expires in ${remaining} minutes</div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="acceptEmergencyQuest()" class="flex-1 bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded font-bold">
                            ‚úì Accept
                        </button>
                        <button onclick="declineEmergencyQuest()" class="flex-1 bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded font-bold">
                            ‚úó Decline
                        </button>
                    </div>
                </div>
            `;
        }

        function acceptEmergencyQuest() {
            if (!gameState.emergencyQuest) return;
            
            const quest = {
                ...gameState.emergencyQuest,
                type: 'daily',
                name: `[EMERGENCY] ${gameState.emergencyQuest.name}`,
                timestamp: Date.now(),
                accepted: true
            };
            
            gameState.quests.push(quest);
            gameState.emergencyQuest = null;
            
            saveGame();
            updateUI();
            showNotification('Emergency Quest accepted!', 'legendary');
        }

        function declineEmergencyQuest() {
            if (!gameState.emergencyQuest) return;
            
            // Small penalty for declining
            gameState.fatigue += 5;
            gameState.emergencyQuest = null;
            
            saveGame();
            updateUI();
            showNotification('Emergency Quest declined. +5% Fatigue penalty', 'error');
        }

        // Store
        document.querySelectorAll('.buy-shard').forEach(btn => {
            btn.addEventListener('click', () => {
                if (gameState.gold >= 100) {
                    gameState.gold -= 100;
                    gameState.shards++;
                    saveGame();
                    updateUI();
                    showNotification('Purchased Soul Shard', 'success');
                } else {
                    showNotification('Not enough Gold', 'error');
                }
            });
        });

        document.querySelectorAll('.buy-shard-10').forEach(btn => {
            btn.addEventListener('click', () => {
                if (gameState.gold >= 900) {
                    gameState.gold -= 900;
                    gameState.shards += 10;
                    saveGame();
                    updateUI();
                    showNotification('Purchased 10 Soul Shards', 'success');
                } else {
                    showNotification('Not enough Gold', 'error');
                }
            });
        });

        // Shadow Fusion
        document.getElementById('fuseShadows').addEventListener('click', () => {
            const idx1 = document.getElementById('fusionShadow1').value;
            const idx2 = document.getElementById('fusionShadow2').value;
            
            if (!idx1 || !idx2 || idx1 === idx2) {
                showNotification('Select two different shadows', 'error');
                return;
            }
            
            const shadow1 = gameState.shadows[idx1];
            const shadow2 = gameState.shadows[idx2];
            
            const newShadow = {
                name: `General ${shadow1.name.split(' ')[shadow1.name.split(' ').length - 1]}`,
                power: shadow1.power + shadow2.power + 100,
                grade: 'General',
                gear: null
            };
            
            // Remove old shadows (remove higher index first)
            const indices = [parseInt(idx1), parseInt(idx2)].sort((a, b) => b - a);
            gameState.shadows.splice(indices[0], 1);
            gameState.shadows.splice(indices[1], 1);
            
            gameState.shadows.push(newShadow);
            saveGame();
            updateUI();
            showNotification(`Fused into ${newShadow.name}!`, 'legendary');
        });

        // Mode toggles
        document.getElementById('stealthBtn').addEventListener('click', () => {
            activateStealth();
        });

        document.getElementById('bloodlustBtn').addEventListener('click', () => {
            activateBloodlust();
        });

        document.getElementById('domainBtn').addEventListener('click', () => {
            activateDomain();
        });

        // Quest mode toggle
        document.getElementById('dailyBtn').addEventListener('click', () => {
            gameState.questMode = 'daily';
            document.getElementById('dailyBtn').classList.add('bg-blue-600');
            document.getElementById('dailyBtn').classList.remove('bg-gray-700');
            document.getElementById('longtermBtn').classList.add('bg-gray-700');
            document.getElementById('longtermBtn').classList.remove('bg-blue-600');
            updateUI();
        });

        document.getElementById('longtermBtn').addEventListener('click', () => {
            gameState.questMode = 'longterm';
            document.getElementById('longtermBtn').classList.add('bg-blue-600');
            document.getElementById('longtermBtn').classList.remove('bg-gray-700');
            document.getElementById('dailyBtn').classList.add('bg-gray-700');
            document.getElementById('dailyBtn').classList.remove('bg-blue-600');
            updateUI();
        });

        // Tab navigation
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.tab;
                
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.classList.remove('bg-blue-600');
                    b.classList.add('bg-gray-700');
                });
                btn.classList.add('bg-blue-600');
                btn.classList.remove('bg-gray-700');
                
                document.querySelectorAll('.content-panel').forEach(p => p.classList.add('hidden'));
                document.getElementById(tab).classList.remove('hidden');
                
                // Render the newly visible tab content
                renderActiveTab();
            });
        });

        // Event listeners
        document.getElementById('addQuest').addEventListener('click', addQuest);
        document.getElementById('craftGear').addEventListener('click', craftGear);
        document.getElementById('addLog').addEventListener('click', addLog);
        document.getElementById('exportJourney').addEventListener('click', exportJourney);
        
        // Sort and Bulk functionality
        document.getElementById('sortQuestsBtn').addEventListener('click', () => {
            const sortOptions = document.getElementById('sortOptions');
            sortOptions.classList.toggle('hidden');
        });
        
        document.getElementById('bulkSelectBtn').addEventListener('click', () => {
            gameState.bulkSelectMode = !gameState.bulkSelectMode;
            const bulkActions = document.getElementById('bulkActions');
            bulkActions.classList.toggle('hidden');
            
            if (!gameState.bulkSelectMode) {
                gameState.selectedQuests.clear();
            }
            
            updateUI();
        });
        
        // Sort options
        document.querySelectorAll('.sort-option').forEach(btn => {
            btn.addEventListener('click', () => {
                const sortBy = btn.dataset.sort;
                gameState.questSort = sortBy;
                
                // Update button states
                document.querySelectorAll('.sort-option').forEach(b => {
                    b.className = 'sort-option px-3 py-1 bg-gray-700 rounded text-sm';
                });
                btn.className = 'sort-option px-3 py-1 bg-blue-600 rounded text-sm';
                
                updateUI();
                showNotification(`Sorted by ${sortBy}`, 'info');
            });
        });
        
        // Bulk actions
        document.getElementById('bulkCompleteBtn').addEventListener('click', () => {
            const selectedIndices = Array.from(gameState.selectedQuests);
            if (selectedIndices.length === 0) {
                showNotification('No quests selected', 'error');
                return;
            }
            
            // Complete in reverse order to avoid index shifting
            selectedIndices.sort((a, b) => b - a).forEach(idx => {
                completeQuest(idx);
            });
            
            gameState.selectedQuests.clear();
            gameState.bulkSelectMode = false;
            document.getElementById('bulkActions').classList.add('hidden');
            updateUI();
            showNotification(`Completed ${selectedIndices.length} quests!`, 'success');
        });
        
        document.getElementById('bulkDeleteBtn').addEventListener('click', () => {
            const selectedIndices = Array.from(gameState.selectedQuests);
            if (selectedIndices.length === 0) {
                showNotification('No quests selected', 'error');
                return;
            }
            
            if (!confirm(`Delete ${selectedIndices.length} quests?`)) return;
            
            const filtered = gameState.quests.filter(q => q.type === gameState.questMode);
            selectedIndices.sort((a, b) => b - a).forEach(idx => {
                const quest = filtered[idx];
                const actualIdx = gameState.quests.indexOf(quest);
                gameState.quests.splice(actualIdx, 1);
            });
            
            gameState.selectedQuests.clear();
            gameState.bulkSelectMode = false;
            document.getElementById('bulkActions').classList.add('hidden');
            saveGame();
            updateUI();
            showNotification(`Deleted ${selectedIndices.length} quests`, 'info');
        });
        
        document.getElementById('cancelBulkBtn').addEventListener('click', () => {
            gameState.bulkSelectMode = false;
            gameState.selectedQuests.clear();
            document.getElementById('bulkActions').classList.add('hidden');
            updateUI();
        });

        // Notification system
        function showNotification(message, type = 'info') {
            const colors = {
                success: 'bg-green-600',
                error: 'bg-red-600',
                legendary: 'bg-blue-600 neon-glow',
                info: 'bg-blue-500'
            };
            
            const notif = document.createElement('div');
            notif.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-all arise-animation`;
            notif.style.boxShadow = '0 0 20px rgba(59, 130, 246, 0.6), 0 8px 32px rgba(0, 0, 0, 0.4)';
            notif.textContent = message;
            document.body.appendChild(notif);
            
            setTimeout(() => {
                notif.style.opacity = '0';
                notif.style.transform = 'translateY(-20px)';
                setTimeout(() => notif.remove(), 300);
            }, 3000);
        }

        // Passive income and Shadow Garden
        setInterval(() => {
            if (gameState.penaltyUntil && Date.now() < gameState.penaltyUntil) return;
            
            // Shadow passive income
            const totalPower = gameState.shadows.reduce((sum, s) => sum + s.power, 0);
            const income = Math.floor(totalPower / 10);
            if (income > 0) {
                gameState.gold += income * gameState.goldMultiplier;
            }
            
            // Shadow Garden income
            if (gameState.shadowGarden.active) {
                const gardenIncome = gameState.shadows.length * 5;
                gameState.shadowGarden.goldGenerated += gardenIncome;
            }
            
            saveGame();
            
            // Only update UI if document is visible (tab is active)
            if (!document.hidden) {
                updateUI();
            }
        }, 10000); // Every 10 seconds

        // Check for midnight reset, emergency quests, and quest expiration every minute
        setInterval(() => {
            checkMidnightReset();
            checkEmergencyQuest();
            checkQuestExpiration();
        }, 60000); // Check every 60 seconds

        // Initialize
        initDomCache();
        loadGame();

        // PWA Installation for Android
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install button if not already installed
            if (!window.matchMedia('(display-mode: standalone)').matches) {
                setTimeout(() => {
                    if (confirm('Install Sovereign Zenith as an app for the best mobile experience?')) {
                        deferredPrompt.prompt();
                        deferredPrompt.userChoice.then((choiceResult) => {
                            if (choiceResult.outcome === 'accepted') {
                                console.log('App installed');
                            }
                            deferredPrompt = null;
                        });
                    }
                }, 3000);
            }
        });

        // Prevent accidental page refresh on mobile
        let lastTouchY = 0;
        let preventPullToRefresh = false;

        document.addEventListener('touchstart', (e) => {
            if (e.touches.length !== 1) { return; }
            lastTouchY = e.touches[0].clientY;
            preventPullToRefresh = window.pageYOffset === 0;
        }, { passive: false });

        document.addEventListener('touchmove', (e) => {
            const touchY = e.touches[0].clientY;
            const touchYDelta = touchY - lastTouchY;
            lastTouchY = touchY;

            if (preventPullToRefresh && touchYDelta > 0) {
                e.preventDefault();
            }
        }, { passive: false });

        // Register service worker for offline functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Create inline service worker
                const swCode = `
                    self.addEventListener('install', (event) => {
                        self.skipWaiting();
                    });
                    
                    self.addEventListener('fetch', (event) => {
                        event.respondWith(
                            caches.match(event.request).then((response) => {
                                return response || fetch(event.request);
                            })
                        );
                    });
                `;
                
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl).then(() => {
                    console.log('Service Worker registered for offline use');
                }).catch((error) => {
                    console.log('Service Worker registration failed:', error);
                });
            });
        }

        // ==================== ENHANCEMENT CODE ====================
        
        // Apply enhanced settings
        function applyEnhancedSettings() {
            const settings = gameState.enhancedSettings || {};
            
            if (settings.darkMode) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
        }
        
        // Settings modal handlers
        setTimeout(() => {
            document.getElementById('openEnhancedSettings')?.addEventListener('click', () => {
                document.getElementById('enhancedSettingsModal').classList.remove('hidden');
                const settings = gameState.enhancedSettings || {};
                document.getElementById('darkModeSelect').value = settings.darkMode ? 'dark' : 'default';
                document.getElementById('autoPotionToggle').checked = settings.autoPotion || false;
                document.getElementById('fatigueWarningToggle').checked = settings.fatigueWarning !== false;
                document.getElementById('hpWarningToggle').checked = settings.hpWarning !== false;
            });
            
            document.getElementById('closeEnhancedSettings')?.addEventListener('click', () => {
                if (!gameState.enhancedSettings) gameState.enhancedSettings = {};
                gameState.enhancedSettings.darkMode = document.getElementById('darkModeSelect').value === 'dark';
                gameState.enhancedSettings.autoPotion = document.getElementById('autoPotionToggle').checked;
                gameState.enhancedSettings.fatigueWarning = document.getElementById('fatigueWarningToggle').checked;
                gameState.enhancedSettings.hpWarning = document.getElementById('hpWarningToggle').checked;
                
                applyEnhancedSettings();
                saveGame();
                document.getElementById('enhancedSettingsModal').classList.add('hidden');
                showNotification('Settings saved!', 'success');
            });
            
            // Initialize settings
            if (!gameState.enhancedSettings) {
                gameState.enhancedSettings = {
                    darkMode: false,
                    autoPotion: false,
                    fatigueWarning: true,
                    hpWarning: true
                };
            }
            applyEnhancedSettings();
        }, 500);
        
        // ==================== QUEST CHAIN SYSTEM ====================
        
        // Initialize quest chains
        function initQuestChains() {
            if (!gameState.questChains) gameState.questChains = {};
            if (!gameState.permanentBuffs) {
                gameState.permanentBuffs = { str: 0, int: 0, agi: 0, sen: 0 };
            }
        }
        
        // Detect if a completed quest matches a chain template
        function checkQuestChain(questName) {
            initQuestChains();
            
            const questLower = questName.toLowerCase();
            let matchedChain = null;
            
            // Check each chain template
            for (const [chainId, template] of Object.entries(chainTemplates)) {
                if (questLower.includes(chainId)) {
                    matchedChain = chainId;
                    break;
                }
            }
            
            if (!matchedChain) return;
            
            // Initialize chain if first time
            if (!gameState.questChains[matchedChain]) {
                gameState.questChains[matchedChain] = {
                    level: 1,
                    streak: 0,
                    lastCompleted: null,
                    completionDates: []
                };
            }
            
            const chain = gameState.questChains[matchedChain];
            const template = chainTemplates[matchedChain];
            const today = new Date().toDateString();
            
            // Check if already completed today
            if (chain.lastCompleted === today) {
                return; // Can only count once per day
            }
            
            // Check if consecutive day
            const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000).toDateString();
            if (chain.lastCompleted === yesterday || chain.lastCompleted === null) {
                chain.streak++;
                chain.completionDates.push(today);
            } else {
                // Streak broken, reset
                chain.streak = 1;
                chain.completionDates = [today];
            }
            
            chain.lastCompleted = today;
            
            // Check for level up (7 days = 1 week)
            if (chain.streak >= 7 && chain.level < template.maxLevel) {
                chain.level++;
                chain.streak = 0; // Reset streak for next level
                
                const currentLevel = template.levels[chain.level - 1];
                
                if (chain.level === template.maxLevel) {
                    // MAX LEVEL REACHED - PERMANENT BUFF!
                    gameState.permanentBuffs[template.statType] += currentLevel.bonus;
                    gameState[template.statType] += currentLevel.bonus;
                    
                    showNotification(`üèÜ CHAIN MASTERED: ${template.finalReward}!`, 'legendary');
                    speakSystem(`Chain mastered! ${template.finalReward}`);
                } else {
                    showNotification(`‚õìÔ∏è Chain Level Up! Now: ${currentLevel.name}`, 'legendary');
                    speakSystem(`Chain leveled up to ${currentLevel.name}`);
                }
            } else if (chain.streak === 3 || chain.streak === 5) {
                showNotification(`üî• ${chain.streak} day streak! ${7 - chain.streak} days until next level!`, 'success');
            }
            
            saveGame();
            renderQuestChains();
        }
        
        // Render quest chains UI
        function renderQuestChains() {
            initQuestChains();
            
            const container = document.getElementById('questChainsList');
            if (!container) return;
            
            const activeChains = Object.entries(gameState.questChains);
            
            if (activeChains.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-400 py-4 text-sm">
                        <p class="mb-2">No active chains yet!</p>
                        <p class="text-xs">Complete quests like "10 Pushups", "Run 1km", "Read 15 min" to start a chain.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = activeChains.map(([chainId, chain]) => {
                const template = chainTemplates[chainId];
                const currentLevel = template.levels[chain.level - 1];
                const isMaxLevel = chain.level === template.maxLevel;
                const progressPercent = (chain.streak / 7) * 100;
                
                const statColors = {
                    str: 'red',
                    int: 'blue',
                    agi: 'green',
                    sen: 'purple'
                };
                const color = statColors[template.statType];
                
                return `
                    <div class="glass rounded p-3 border-2 border-${color}-500 ${isMaxLevel ? 'bg-' + color + '-900/20' : ''}">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex-1">
                                <div class="font-bold text-${color}-400">
                                    ${isMaxLevel ? 'üëë ' : '‚õìÔ∏è '}${currentLevel.name}
                                </div>
                                <div class="text-xs text-gray-400">
                                    ${template.statType.toUpperCase()} Chain ‚Ä¢ Level ${chain.level}/${template.maxLevel}
                                </div>
                            </div>
                            <div class="text-right text-xs">
                                ${isMaxLevel ? 
                                    `<div class="text-yellow-400 font-bold">MASTERED</div>` :
                                    `<div class="text-${color}-400">${chain.streak}/7 days</div>`
                                }
                            </div>
                        </div>
                        
                        ${!isMaxLevel ? `
                            <div class="w-full bg-gray-700 rounded-full h-2 mb-2">
                                <div class="bg-${color}-500 h-full rounded-full transition-all" style="width: ${progressPercent}%"></div>
                            </div>
                            <div class="text-xs text-gray-400">
                                ${7 - chain.streak} days until next level
                            </div>
                        ` : `
                            <div class="text-xs text-yellow-400 font-bold mt-1">
                                ‚ú® ${template.finalReward}
                            </div>
                        `}
                    </div>
                `;
            }).join('');
        }
        
        // Initialize chains on load
        setTimeout(() => {
            initQuestChains();
            renderQuestChains();
        }, 1000);
        
        // PWA FIX: Force render when app becomes visible
        // This fixes the issue where quests don't show after adding to home screen
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                console.log('App became visible - forcing render');
                setTimeout(() => {
                    renderQuests();
                    renderSavedQuests();
                }, 100);
            }
        });
        
        // PWA FIX: Force render when app gains focus
        window.addEventListener('focus', () => {
            console.log('App gained focus - forcing render');
            setTimeout(() => {
                renderQuests();
                renderSavedQuests();
            }, 100);
        });
        
        // PWA FIX: Force render on page show (back/forward cache)
        window.addEventListener('pageshow', (event) => {
            console.log('Page show event - forcing render');
            setTimeout(() => {
                renderQuests();
                renderSavedQuests();
            }, 100);
        });
        
        // ==================== END QUEST CHAIN SYSTEM ====================
        
        // ==================== END ENHANCEMENT CODE ====================
    </script>
</body>
</html>